<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>/home/travis/build/esl/MongooseIM/test/ejabberd_tests/tests/ejabberdctl_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%==============================================================================</i>
<a name="2"/>    2: <i>%% Copyright 2013 Erlang Solutions Ltd.</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="5"/>    5: <i>%% you may not use this file except in compliance with the License.</i>
<a name="6"/>    6: <i>%% You may obtain a copy of the License at</i>
<a name="7"/>    7: <i>%%</i>
<a name="8"/>    8: <i>%% http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="11"/>   11: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="12"/>   12: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="13"/>   13: <i>%% See the License for the specific language governing permissions and</i>
<a name="14"/>   14: <i>%% limitations under the License.</i>
<a name="15"/>   15: <i>%%==============================================================================</i>
<a name="16"/>   16: <b>-module</b>(ejabberdctl_SUITE).
<a name="17"/>   17: <b>-compile</b>(export_all).
<a name="18"/>   18: 
<a name="19"/>   19: <b>-include_lib</b>(&quot;escalus/include/escalus.hrl&quot;).
<a name="20"/>   20: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="21"/>   21: <b>-include_lib</b>(&quot;exml/include/exml.hrl&quot;).
<a name="22"/>   22: <b>-include_lib</b>(&quot;exml/include/exml.hrl&quot;).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-import</b>(ejabberdctl_helper, [ejabberdctl/3, rpc_call/3]).
<a name="25"/>   25: <b>-import</b>(mongoose_helper, [auth_modules/0]).
<a name="26"/>   26: <b>-import</b>(ejabberd_node_utils, [mim/0]).
<a name="27"/>   27: 
<a name="28"/>   28: <b>-define</b>(SINGLE_QUOTE_CHAR, $\').
<a name="29"/>   29: <b>-define</b>(DOUBLE_QUOTE_CHAR, $\&quot;).
<a name="30"/>   30: 
<a name="31"/>   31: <b>-record</b>(offline_msg, {us, timestamp, expire, from, to, packet}).
<a name="32"/>   32: 
<a name="33"/>   33: <i>%%--------------------------------------------------------------------</i>
<a name="34"/>   34: <i>%% Suite configuration</i>
<a name="35"/>   35: <i>%%--------------------------------------------------------------------</i>
<a name="36"/>   36: 
<a name="all-0"/><a name="37"/>   37: <b>all</b>() -&gt;
<a name="38"/>   38:     AuthMods = auth_modules(),
<a name="all-last_expr"/><a name="39"/>   39: <b>    case lists:member</b>(ejabberd_auth_external, AuthMods) of
<a name="40"/>   40:         true -&gt;
<a name="41"/>   41:             {skip, external_auth_not_supported};
<a name="42"/>   42:         false -&gt;
<a name="43"/>   43:             [{group, accounts},
<a name="44"/>   44:              {group, sessions},
<a name="45"/>   45:              {group, vcard},
<a name="46"/>   46:              {group, roster},
<a name="47"/>   47:              {group, roster_advanced},
<a name="48"/>   48:              {group, last},
<a name="49"/>   49:              {group, private},
<a name="50"/>   50:              {group, stanza},
<a name="51"/>   51:              {group, stats},
<a name="52"/>   52:              {group, basic}]
<a name="53"/>   53:     end.
<a name="54"/>   54: 
<a name="groups-0"/><a name="55"/>   55: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="56"/>   56: <b>     [{accounts, [sequence], accounts</b>()},
<a name="57"/>   57:       {sessions, [sequence], sessions()},
<a name="58"/>   58:       {vcard, [sequence], vcard()},
<a name="59"/>   59:       {roster, [sequence], roster()},
<a name="60"/>   60:       {last, [sequence], last()},
<a name="61"/>   61:       {private, [sequence], private()},
<a name="62"/>   62:       {stanza, [sequence], stanza()},
<a name="63"/>   63:       {roster_advanced, [sequence], roster_advanced()},
<a name="64"/>   64:       {basic, [sequence], basic()},
<a name="65"/>   65:       {stats, [sequence], stats()}].
<a name="66"/>   66: 
<a name="basic-0"/><a name="67"/>   67: <b>basic</b>() -&gt;
<a name="basic-last_expr"/><a name="68"/>   68:     [simple_register, simple_unregister, register_twice,
<a name="69"/>   69:         backup_restore_mnesia,
<a name="70"/>   70:         restore_mnesia_wrong,
<a name="71"/>   71:         dump_and_load,
<a name="72"/>   72:         load_mnesia_wrong,
<a name="73"/>   73:         dump_table,
<a name="74"/>   74:         get_loglevel,
<a name="75"/>   75:         remove_old_messages_test,
<a name="76"/>   76:         remove_expired_messages_test
<a name="77"/>   77:     ].
<a name="78"/>   78: 
<a name="accounts-0"/><a name="accounts-last_expr"/><a name="79"/>   79: <b>accounts</b>() -&gt; [change_password, check_password_hash, check_password,
<a name="80"/>   80:                check_account, ban_account, num_active_users, delete_old_users,
<a name="81"/>   81:                delete_old_users_vhost].
<a name="82"/>   82: 
<a name="sessions-0"/><a name="sessions-last_expr"/><a name="83"/>   83: <b>sessions</b>() -&gt; [num_resources_num, kick_session, status,
<a name="84"/>   84:                sessions_info, set_presence].
<a name="85"/>   85: 
<a name="vcard-0"/><a name="vcard-last_expr"/><a name="86"/>   86: <b>vcard</b>() -&gt; [vcard_rw, vcard2_rw, vcard2_multi_rw].
<a name="87"/>   87: 
<a name="roster-0"/><a name="roster-last_expr"/><a name="88"/>   88: <b>roster</b>() -&gt; [rosteritem_rw, presence_after_add_rosteritem,
<a name="89"/>   89:              push_roster,
<a name="90"/>   90:              push_roster_all,
<a name="91"/>   91:              push_roster_alltoall].
<a name="92"/>   92: 
<a name="roster_advanced-0"/><a name="roster_advanced-last_expr"/><a name="93"/>   93: <b>roster_advanced</b>() -&gt;[process_rosteritems_list_simple,
<a name="94"/>   94:                           process_rosteritems_list_nomatch,
<a name="95"/>   95:                           process_rosteritems_list_advanced1,
<a name="96"/>   96:                           process_rosteritems_list_advanced2,
<a name="97"/>   97:                           process_rosteritems_delete_advanced,
<a name="98"/>   98:                           process_rosteritems_delete_advanced2].
<a name="99"/>   99: 
<a name="last-0"/><a name="last-last_expr"/><a name="100"/>  100: <b>last</b>() -&gt; [set_last].
<a name="101"/>  101: 
<a name="private-0"/><a name="private-last_expr"/><a name="102"/>  102: <b>private</b>() -&gt; [private_rw].
<a name="103"/>  103: 
<a name="stanza-0"/><a name="stanza-last_expr"/><a name="104"/>  104: <b>stanza</b>() -&gt; [send_message, send_message_wrong_jid, send_stanza, send_stanzac2s_wrong].
<a name="105"/>  105: 
<a name="stats-0"/><a name="stats-last_expr"/><a name="106"/>  106: <b>stats</b>() -&gt; [stats_global, stats_host].
<a name="107"/>  107: 
<a name="suite-0"/><a name="108"/>  108: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="109"/>  109: <b>    escalus:suite</b>().
<a name="110"/>  110: 
<a name="init_per_suite-1"/><a name="111"/>  111: <b>init_per_suite</b>(Config) -&gt;
<a name="112"/>  112:     Cwd0 = escalus_config:get_config(data_dir, Config),
<a name="113"/>  113:     CwdTokens = string:tokens(Cwd0, &quot;/&quot;),
<a name="114"/>  114:     Cwd =  [$/ | string:join(lists:sublist(CwdTokens, 1, length(CwdTokens)-2), &quot;/&quot;)],
<a name="115"/>  115:     TemplatePath = Cwd ++ &quot;/roster.template&quot;,
<a name="116"/>  116:     start_mod_admin_extra(),
<a name="117"/>  117:     AuthMods = auth_modules(),
<a name="118"/>  118:     Node = mim(),
<a name="119"/>  119:     Config1 = ejabberd_node_utils:init(Node, Config),
<a name="120"/>  120:     Config2 = escalus:init_per_suite([{ctl_auth_mods, AuthMods},
<a name="121"/>  121:                                         {roster_template, TemplatePath} | Config1]),
<a name="init_per_suite-last_expr"/><a name="122"/>  122: <b>    escalus:create_users</b>(Config2, escalus:get_users([alice, mike, bob, kate])).
<a name="123"/>  123: 
<a name="end_per_suite-1"/><a name="124"/>  124: <b>end_per_suite</b>(Config) -&gt;
<a name="125"/>  125:     Config1 = lists:keydelete(ctl_auth_mods, 1, Config),
<a name="126"/>  126:     delete_users(Config1),
<a name="end_per_suite-last_expr"/><a name="127"/>  127: <b>    escalus:end_per_suite</b>(Config1).
<a name="128"/>  128: 
<a name="init_per_group-2"/><a name="129"/>  129: <b>init_per_group</b>(vcard, Config) -&gt;
<a name="130"/>  130:     case escalus_ejabberd:rpc(gen_mod,get_module_opt,
<a name="131"/>  131:                               [ct:get_config(ejabberd_domain),
<a name="132"/>  132:                                mod_vcard, backend, mnesia]) of
<a name="133"/>  133:         ldap -&gt;
<a name="134"/>  134:             {skip, vcard_set_not_supported_with_ldap};
<a name="135"/>  135:         _ -&gt;
<a name="136"/>  136:             Config
<a name="137"/>  137:     end;
<a name="138"/>  138: 
<a name="139"/>  139: <b>init_per_group</b>(roster_advanced, Config) -&gt;
<a name="140"/>  140:     case escalus_ejabberd:rpc(gen_mod,get_module_opt,[ct:get_config(ejabberd_domain), mod_roster, backend, mnesia]) of
<a name="141"/>  141:         mnesia -&gt;
<a name="142"/>  142:             Config;
<a name="143"/>  143:         _ -&gt;
<a name="144"/>  144:             {skip, command_process_rosteritems_supports_only_mnesia}
<a name="145"/>  145:     end;
<a name="146"/>  146: 
<a name="147"/>  147: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="148"/>  148:     Config.
<a name="149"/>  149: 
<a name="end_per_group-2"/><a name="150"/>  150: <b>end_per_group</b>(Rosters, Config) when (Rosters == roster) or (Rosters == roster_advanced) -&gt;
<a name="151"/>  151:     TemplatePath = escalus_config:get_config(roster_template, Config),
<a name="152"/>  152:     RegUsers = [atom_to_list(U) || {U, _} &lt;- escalus_config:get_config(escalus_users, Config)],
<a name="153"/>  153:     {ok, [Roster]} = file:consult(TemplatePath),
<a name="154"/>  154:     io:format(&quot;Roster is ~p~n and registred is ~p&quot;,[Roster, RegUsers]),
<a name="155"/>  155:     C = fun({U, S, _, _}) -&gt;
<a name="156"/>  156:         case lists:member(U, RegUsers) of
<a name="157"/>  157:             true -&gt;
<a name="158"/>  158:                 SB = string_to_binary(S),
<a name="159"/>  159:                 UB = string_to_binary(U),
<a name="160"/>  160:                 escalus_ejabberd:rpc(ejabberd_hooks, run, [remove_user, SB, [UB, SB]]);
<a name="161"/>  161:             _ -&gt;
<a name="162"/>  162:                ok
<a name="163"/>  163:         end
<a name="164"/>  164:     end,
<a name="165"/>  165:     lists:foreach(C, Roster),
<a name="166"/>  166:     Config;
<a name="167"/>  167: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="168"/>  168:     Config.
<a name="169"/>  169: 
<a name="init_per_testcase-2"/><a name="170"/>  170: <b>init_per_testcase</b>(CaseName, Config)
<a name="171"/>  171:   % these cases are incompatible with domainless odbc schema
<a name="172"/>  172:   when CaseName == delete_old_users_vhost
<a name="173"/>  173:        orelse CaseName == stats_global
<a name="174"/>  174:        orelse CaseName == stats_host -&gt;
<a name="175"/>  175:     {_, AuthMods} = lists:keyfind(ctl_auth_mods, 1, Config),
<a name="176"/>  176:     case lists:member(ejabberd_auth_odbc, AuthMods) orelse
<a name="177"/>  177:          lists:member(ejabberd_auth_ldap, AuthMods) of
<a name="178"/>  178:         true -&gt; {skip, vhost_odbc_incompatible};
<a name="179"/>  179:         false -&gt; escalus:init_per_testcase(CaseName, Config)
<a name="180"/>  180:     end;
<a name="181"/>  181: <b>init_per_testcase</b>(CaseName, Config)
<a name="182"/>  182:     when CaseName == check_password_hash;
<a name="183"/>  183:          CaseName == delete_old_users -&gt;
<a name="184"/>  184:     {_, AuthMods} = lists:keyfind(ctl_auth_mods, 1, Config),
<a name="185"/>  185:     case lists:member(ejabberd_auth_ldap, AuthMods) of
<a name="186"/>  186:         true -&gt; {skip, not_fully_supported_with_ldap};
<a name="187"/>  187:         false -&gt; escalus:init_per_testcase(CaseName, Config)
<a name="188"/>  188:     end;
<a name="189"/>  189: <b>init_per_testcase</b>(CaseName, Config) -&gt;
<a name="init_per_testcase-last_expr"/><a name="190"/>  190: <b>    escalus:init_per_testcase</b>(CaseName, Config).
<a name="191"/>  191: 
<a name="end_per_testcase-2"/><a name="192"/>  192: <b>end_per_testcase</b>(delete_old_users, Config) -&gt;
<a name="193"/>  193:     Users = escalus_users:get_users([alice, bob, kate, mike]),
<a name="194"/>  194:     lists:foreach(fun({_User, UserSpec}) -&gt;
<a name="195"/>  195:                 {Username, Domain, Pass} = get_user_data(UserSpec, Config),
<a name="196"/>  196:                 escalus_ejabberd:rpc(ejabberd_auth, try_register, [Username, Domain, Pass])
<a name="197"/>  197:         end, Users),
<a name="198"/>  198:     escalus_cleaner:clean(Config),
<a name="199"/>  199:     escalus:end_per_testcase(delete_old_users, Config);
<a name="200"/>  200: <b>end_per_testcase</b>(CaseName, Config) -&gt;
<a name="201"/>  201:     escalus_cleaner:clean(Config),
<a name="end_per_testcase-last_expr"/><a name="202"/>  202: <b>    escalus:end_per_testcase</b>(CaseName, Config).
<a name="203"/>  203: 
<a name="204"/>  204: <i>%%--------------------------------------------------------------------</i>
<a name="205"/>  205: <i>%% mod_admin_extra_accounts tests</i>
<a name="206"/>  206: <i>%%--------------------------------------------------------------------</i>
<a name="207"/>  207: 
<a name="change_password-1"/><a name="208"/>  208: <b>change_password</b>(Config) -&gt;
<a name="209"/>  209:     {User, Domain, OldPassword} = get_user_data(alice, Config),
<a name="210"/>  210:     ejabberdctl(&quot;change_password&quot;, [User, Domain, &lt;&lt;OldPassword/binary, $2&gt;&gt;], Config),
<a name="211"/>  211:     {error, {connection_step_failed, _, _}} = escalus_client:start_for(Config, alice, &lt;&lt;&quot;newres&quot;&gt;&gt;),
<a name="212"/>  212:     ejabberdctl(&quot;change_password&quot;, [User, Domain, OldPassword], Config),
<a name="change_password-last_expr"/><a name="213"/>  213: <b>    {ok, _Alice2} = escalus_client:start_for</b>(Config, alice, &lt;&lt;&quot;newres2&quot;&gt;&gt;).
<a name="214"/>  214: 
<a name="check_password_hash-1"/><a name="215"/>  215: <b>check_password_hash</b>(Config) -&gt;
<a name="216"/>  216:     {User, Domain, Pass} = get_user_data(alice, Config),
<a name="217"/>  217:     MD5Hash = get_md5(Pass),
<a name="218"/>  218:     MD5HashBad = get_md5(&lt;&lt;Pass/binary, &quot;bad&quot;&gt;&gt;),
<a name="219"/>  219:     SHAHash = get_sha(Pass),
<a name="220"/>  220: 
<a name="221"/>  221:     {_, 0} = ejabberdctl(&quot;check_password_hash&quot;, [User, Domain, MD5Hash, &quot;md5&quot;], Config),
<a name="222"/>  222:     {_, ErrCode} = ejabberdctl(&quot;check_password_hash&quot;, [User, Domain, MD5HashBad, &quot;md5&quot;], Config),
<a name="223"/>  223:     true = (ErrCode =/= 0), %% Must return code other than 0
<a name="check_password_hash-last_expr"/><a name="224"/>  224: <b>    {_, 0} = ejabberdctl</b>(&quot;check_password_hash&quot;, [User, Domain, SHAHash, &quot;sha&quot;], Config).
<a name="225"/>  225: 
<a name="check_password-1"/><a name="226"/>  226: <b>check_password</b>(Config) -&gt;
<a name="227"/>  227:     {User, Domain, Pass} = get_user_data(alice, Config),
<a name="228"/>  228: 
<a name="229"/>  229:     {_, 0} = ejabberdctl(&quot;check_password&quot;, [User, Domain, Pass], Config),
<a name="230"/>  230:     {_, ErrCode} = ejabberdctl(&quot;check_password&quot;, [User, Domain, &lt;&lt;Pass/binary, &quot;Bad&quot;&gt;&gt;], Config),
<a name="check_password-last_expr"/><a name="231"/>  231: <b>    true = </b>(ErrCode =/= 0). %% Must return code other than 0
<a name="232"/>  232: 
<a name="check_account-1"/><a name="233"/>  233: <b>check_account</b>(Config) -&gt;
<a name="234"/>  234:     {User, Domain, _Pass} = get_user_data(alice, Config),
<a name="235"/>  235: 
<a name="236"/>  236:     {_, 0} = ejabberdctl(&quot;check_account&quot;, [User, Domain], Config),
<a name="237"/>  237:     {_, ErrCode} = ejabberdctl(&quot;check_account&quot;, [&lt;&lt;User/binary, &quot;Bad&quot;&gt;&gt;, Domain], Config),
<a name="check_account-last_expr"/><a name="238"/>  238: <b>    true = </b>(ErrCode =/= 0). %% Must return code other than 0
<a name="239"/>  239: 
<a name="ban_account-1"/><a name="240"/>  240: <b>ban_account</b>(Config) -&gt;
<a name="241"/>  241:     {User, Domain, Pass} = get_user_data(mike, Config),
<a name="242"/>  242: 
<a name="243"/>  243:     {ok, Mike} = escalus_client:start_for(Config, mike, &lt;&lt;&quot;newres&quot;&gt;&gt;),
<a name="244"/>  244:     {_, 0} = ejabberdctl(&quot;ban_account&quot;, [User, Domain, &quot;SomeReason&quot;], Config),
<a name="245"/>  245:     escalus:assert(is_stream_error, [&lt;&lt;&quot;conflict&quot;&gt;&gt;, &lt;&lt;&quot;SomeReason&quot;&gt;&gt;], escalus:wait_for_stanza(Mike)),
<a name="246"/>  246:     {error, {connection_step_failed, _, _}} = escalus_client:start_for(Config, mike, &lt;&lt;&quot;newres2&quot;&gt;&gt;),
<a name="ban_account-last_expr"/><a name="247"/>  247: <b>    ejabberdctl</b>(&quot;change_password&quot;, [User, Domain, Pass], Config).
<a name="248"/>  248: 
<a name="num_active_users-1"/><a name="249"/>  249: <b>num_active_users</b>(Config) -&gt;
<a name="250"/>  250:     {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="251"/>  251:     {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="252"/>  252: 
<a name="253"/>  253:     {Mega, Secs, _} = erlang:now(),
<a name="254"/>  254:     Now = Mega*1000000+Secs,
<a name="255"/>  255:     set_last(AliceName, Domain, Now),
<a name="256"/>  256:     set_last(MikeName, Domain, Now - 864000), %% Now - 10 days
<a name="num_active_users-last_expr"/><a name="257"/>  257: <b>    {&quot;1\n&quot;, _} = ejabberdctl</b>(&quot;num_active_users&quot;, [Domain, &quot;5&quot;], Config).
<a name="258"/>  258: 
<a name="delete_old_users-1"/><a name="259"/>  259: <b>delete_old_users</b>(Config) -&gt;
<a name="260"/>  260:     {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="261"/>  261:     {BobName, Domain, _} = get_user_data(bob, Config),
<a name="262"/>  262:     {KateName, Domain, _} = get_user_data(kate, Config),
<a name="263"/>  263:     {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="264"/>  264: 
<a name="265"/>  265:     {Mega, Secs, _} = erlang:now(),
<a name="266"/>  266:     Now = Mega*1000000+Secs,
<a name="267"/>  267:     set_last(AliceName, Domain, Now),
<a name="268"/>  268:     set_last(BobName, Domain, Now),
<a name="269"/>  269:     set_last(MikeName, Domain, Now),
<a name="270"/>  270: 
<a name="271"/>  271:     {_, 0} = ejabberdctl(&quot;delete_old_users&quot;, [&quot;10&quot;], Config),
<a name="272"/>  272:     {_, 0} = ejabberdctl(&quot;check_account&quot;, [AliceName, Domain], Config),
<a name="273"/>  273:     {_, ErrCode} = ejabberdctl(&quot;check_account&quot;, [KateName, Domain], Config),
<a name="delete_old_users-last_expr"/><a name="274"/>  274: <b>    true = </b>(ErrCode =/= 0). %% Must return code other than 0
<a name="275"/>  275: 
<a name="delete_old_users_vhost-1"/><a name="276"/>  276: <b>delete_old_users_vhost</b>(Config) -&gt;
<a name="277"/>  277:     {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="278"/>  278:     {KateName, Domain, KatePass} = get_user_data(kate, Config),
<a name="279"/>  279:     SecDomain = escalus_config:get_config(ejabberd_secondary_domain, Config),
<a name="280"/>  280: 
<a name="281"/>  281:     {Mega, Secs, _} = erlang:now(),
<a name="282"/>  282:     Now = Mega*1000000+Secs,
<a name="283"/>  283:     set_last(AliceName, Domain, Now-86400*30),
<a name="284"/>  284: 
<a name="285"/>  285:     {_, 0} = ejabberdctl(&quot;register&quot;, [KateName, SecDomain, KatePass], Config),
<a name="286"/>  286:     {_, 0} = ejabberdctl(&quot;check_account&quot;, [KateName, SecDomain], Config),
<a name="287"/>  287:     {_, 0} = ejabberdctl(&quot;delete_old_users_vhost&quot;, [SecDomain, &quot;10&quot;], Config),
<a name="288"/>  288:     {_, 0} = ejabberdctl(&quot;check_account&quot;, [AliceName, Domain], Config),
<a name="289"/>  289:     {_, ErrCode} = ejabberdctl(&quot;check_account&quot;, [KateName, SecDomain], Config),
<a name="delete_old_users_vhost-last_expr"/><a name="290"/>  290: <b>    true = </b>(ErrCode =/= 0). %% Must return code other than 0
<a name="291"/>  291: 
<a name="292"/>  292: <i>%%--------------------------------------------------------------------</i>
<a name="293"/>  293: <i>%% mod_admin_extra_accounts tests</i>
<a name="294"/>  294: <i>%%--------------------------------------------------------------------</i>
<a name="295"/>  295: 
<a name="296"/>  296: <i>%% Checks both num_resources and resource_num</i>
<a name="num_resources_num-1"/><a name="297"/>  297: <b>num_resources_num</b>(Config) -&gt;
<a name="num_resources_num-last_expr"/><a name="298"/>  298: <b>    escalus:story</b>(Config, [{alice, 3}, {bob, 1}], fun(_, Alice2, _, _) -&gt;
<a name="299"/>  299:                 {Username, Domain, _} = get_user_data(alice, Config),
<a name="300"/>  300:                 ResName = binary_to_list(escalus_client:resource(Alice2)) ++ &quot;\n&quot;,
<a name="301"/>  301: 
<a name="302"/>  302:                 {&quot;3\n&quot;, _} = ejabberdctl(&quot;num_resources&quot;, [Username, Domain], Config),
<a name="303"/>  303:                 {ResName, _} = ejabberdctl(&quot;resource_num&quot;, [Username, Domain, &quot;2&quot;], Config)
<a name="304"/>  304:         end).
<a name="305"/>  305: 
<a name="kick_session-1"/><a name="306"/>  306: <b>kick_session</b>(Config) -&gt;
<a name="kick_session-last_expr"/><a name="307"/>  307: <b>    escalus:story</b>(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="308"/>  308:                 Username = escalus_client:username(Alice),
<a name="309"/>  309:                 Domain = escalus_client:server(Alice),
<a name="310"/>  310:                 Resource = escalus_client:resource(Alice),
<a name="311"/>  311: 
<a name="312"/>  312:                 {_, 0} = ejabberdctl(&quot;kick_session&quot;, [Username, Domain, Resource, &quot;\&quot;Because I can!\&quot;&quot;], Config),
<a name="313"/>  313:                 Stanza = escalus:wait_for_stanza(Alice),
<a name="314"/>  314:                 escalus:assert(is_stream_error, [&lt;&lt;&quot;conflict&quot;&gt;&gt;, &lt;&lt;&quot;Because I can!&quot;&gt;&gt;], Stanza)
<a name="315"/>  315:         end).
<a name="316"/>  316: 
<a name="status-1"/><a name="317"/>  317: <b>status</b>(Config) -&gt;
<a name="status-last_expr"/><a name="318"/>  318: <b>    escalus:story</b>(Config, [{alice, 1}, {mike, 1}, {bob, 1}], fun(User1, User2, User3) -&gt;
<a name="319"/>  319:                 PriDomain = escalus_client:server(User1),
<a name="320"/>  320:                 SecDomain = escalus_config:get_config(ejabberd_secondary_domain, Config),
<a name="321"/>  321:                 AwayPresence = escalus_stanza:presence_show(&lt;&lt;&quot;away&quot;&gt;&gt;),
<a name="322"/>  322:                 escalus_client:send(User2, AwayPresence),
<a name="323"/>  323: 
<a name="324"/>  324:                 {&quot;2\n&quot;, _} = ejabberdctl(&quot;status_num&quot;, [&quot;available&quot;], Config),
<a name="325"/>  325: 
<a name="326"/>  326:                 {&quot;2\n&quot;, _} = ejabberdctl(&quot;status_num_host&quot;, [PriDomain, &quot;available&quot;], Config),
<a name="327"/>  327:                 {&quot;0\n&quot;, _} = ejabberdctl(&quot;status_num_host&quot;, [SecDomain, &quot;available&quot;], Config),
<a name="328"/>  328: 
<a name="329"/>  329:                 {StatusList, _} = ejabberdctl(&quot;status_list&quot;, [&quot;available&quot;], Config),
<a name="330"/>  330:                 match_user_status([User1, User3], StatusList),
<a name="331"/>  331: 
<a name="332"/>  332:                 {StatusList2, _} = ejabberdctl(&quot;status_list_host&quot;, [PriDomain, &quot;available&quot;], Config),
<a name="333"/>  333:                 match_user_status([User1, User3], StatusList2),
<a name="334"/>  334:                 {[], _} = ejabberdctl(&quot;status_list_host&quot;, [SecDomain, &quot;available&quot;], Config)
<a name="335"/>  335:         end).
<a name="336"/>  336: 
<a name="sessions_info-1"/><a name="337"/>  337: <b>sessions_info</b>(Config) -&gt;
<a name="sessions_info-last_expr"/><a name="338"/>  338: <b>    escalus:story</b>(Config, [{alice, 1}, {bob, 1}, {kate, 1}], fun(User1, User2, User3) -&gt;
<a name="339"/>  339:                 Username1 = escalus_client:username(User1),
<a name="340"/>  340:                 PriDomain = escalus_client:server(User1),
<a name="341"/>  341:                 SecDomain = escalus_config:get_config(ejabberd_secondary_domain, Config),
<a name="342"/>  342:                 AwayPresence = escalus_stanza:presence_show(&lt;&lt;&quot;away&quot;&gt;&gt;),
<a name="343"/>  343:                 escalus_client:send(User2, AwayPresence),
<a name="344"/>  344: 
<a name="345"/>  345:                 {UserList, _} = ejabberdctl(&quot;connected_users_info&quot;, [], Config),
<a name="346"/>  346:                 match_user_info([User1, User2, User3], UserList),
<a name="347"/>  347: 
<a name="348"/>  348:                 {UserList2, _} = ejabberdctl(&quot;connected_users_vhost&quot;, [PriDomain], Config),
<a name="349"/>  349:                 match_user_info([User1, User2, User3], UserList2),
<a name="350"/>  350:                 {[], _} = ejabberdctl(&quot;connected_users_vhost&quot;, [SecDomain], Config),
<a name="351"/>  351: 
<a name="352"/>  352:                 {UserList3, _} = ejabberdctl(&quot;user_sessions_info&quot;, [Username1, PriDomain], Config),
<a name="353"/>  353:                 match_user_info([User1], UserList3)
<a name="354"/>  354:         end).
<a name="355"/>  355: 
<a name="set_presence-1"/><a name="356"/>  356: <b>set_presence</b>(Config) -&gt;
<a name="set_presence-last_expr"/><a name="357"/>  357: <b>    escalus:story</b>(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="358"/>  358:                 Username = escalus_client:username(Alice),
<a name="359"/>  359:                 Domain = escalus_client:server(Alice),
<a name="360"/>  360:                 Resource = escalus_client:resource(Alice),
<a name="361"/>  361: 
<a name="362"/>  362:                 {_, 0} = ejabberdctl(&quot;set_presence&quot;, [Username, Domain, Resource,
<a name="363"/>  363:                                                       &quot;available&quot;, &quot;away&quot;, &quot;mystatus&quot;, &quot;10&quot;], Config),
<a name="364"/>  364:                 Presence = escalus:wait_for_stanza(Alice),
<a name="365"/>  365:                 escalus:assert(is_presence_with_show, [&lt;&lt;&quot;away&quot;&gt;&gt;], Presence),
<a name="366"/>  366:                 escalus:assert(is_presence_with_status, [&lt;&lt;&quot;mystatus&quot;&gt;&gt;], Presence),
<a name="367"/>  367:                 escalus:assert(is_presence_with_priority, [&lt;&lt;&quot;10&quot;&gt;&gt;], Presence)
<a name="368"/>  368:         end).
<a name="369"/>  369: 
<a name="370"/>  370: <i>%%--------------------------------------------------------------------</i>
<a name="371"/>  371: <i>%% mod_admin_extra_vcard tests</i>
<a name="372"/>  372: <i>%%--------------------------------------------------------------------</i>
<a name="373"/>  373: 
<a name="vcard_rw-1"/><a name="374"/>  374: <b>vcard_rw</b>(Config) -&gt;
<a name="375"/>  375:     {Username, Domain, _} = get_user_data(alice, Config),
<a name="376"/>  376: 
<a name="377"/>  377:     {_, ExitCode} = ejabberdctl(&quot;get_vcard&quot;, [Username, Domain, &quot;NICKNAME&quot;], Config),
<a name="378"/>  378:     true = (ExitCode /= 0),
<a name="379"/>  379: 
<a name="380"/>  380:     {_, 0} = ejabberdctl(&quot;set_vcard&quot;, [Username, Domain, &quot;NICKNAME&quot;, &quot;SomeNickname&quot;], Config),
<a name="vcard_rw-last_expr"/><a name="381"/>  381: <b>    {&quot;SomeNickname\n&quot;, 0} = ejabberdctl</b>(&quot;get_vcard&quot;, [Username, Domain, &quot;NICKNAME&quot;], Config).
<a name="382"/>  382: 
<a name="vcard2_rw-1"/><a name="383"/>  383: <b>vcard2_rw</b>(Config) -&gt;
<a name="384"/>  384:     {Username, Domain, _} = get_user_data(alice, Config),
<a name="385"/>  385: 
<a name="386"/>  386:     {_, ExitCode} = ejabberdctl(&quot;get_vcard2&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGNAME&quot;], Config),
<a name="387"/>  387:     true = (ExitCode /= 0),
<a name="388"/>  388: 
<a name="389"/>  389:     {_, 0} = ejabberdctl(&quot;set_vcard2&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGNAME&quot;, &quot;ESL&quot;], Config),
<a name="vcard2_rw-last_expr"/><a name="390"/>  390: <b>    {&quot;ESL\n&quot;, 0} = ejabberdctl</b>(&quot;get_vcard2&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGNAME&quot;], Config).
<a name="391"/>  391: 
<a name="vcard2_multi_rw-1"/><a name="392"/>  392: <b>vcard2_multi_rw</b>(Config) -&gt;
<a name="393"/>  393:     {Username, Domain, _} = get_user_data(alice, Config),
<a name="394"/>  394: 
<a name="395"/>  395:     {_, ExitCode} = ejabberdctl(&quot;get_vcard2_multi&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGUNIT&quot;], Config),
<a name="396"/>  396:     true = (ExitCode /= 0),
<a name="397"/>  397: 
<a name="398"/>  398:     {_, 0} = ejabberdctl(&quot;set_vcard2_multi&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGUNIT&quot;, &quot;'sales;marketing'&quot;], Config),
<a name="399"/>  399:     {OrgUnits0, 0} = ejabberdctl(&quot;get_vcard2_multi&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGUNIT&quot;], Config),
<a name="400"/>  400:     OrgUnits = string:tokens(OrgUnits0, &quot;\n&quot;),
<a name="401"/>  401:     2 = length(OrgUnits),
<a name="vcard2_multi_rw-last_expr"/><a name="402"/>  402: <b>    true = </b>(lists:member(&quot;sales&quot;, OrgUnits) andalso lists:member(&quot;marketing&quot;, OrgUnits)).
<a name="403"/>  403: 
<a name="404"/>  404: <i>%%--------------------------------------------------------------------</i>
<a name="405"/>  405: <i>%% mod_admin_extra_vcard tests</i>
<a name="406"/>  406: <i>%%--------------------------------------------------------------------</i>
<a name="407"/>  407: 
<a name="rosteritem_rw-1"/><a name="408"/>  408: <b>rosteritem_rw</b>(Config) -&gt;
<a name="rosteritem_rw-last_expr"/><a name="409"/>  409: <b>    escalus:story</b>(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="410"/>  410:                 {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="411"/>  411:                 {BobName, Domain, _} = get_user_data(bob, Config),
<a name="412"/>  412:                 {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="413"/>  413: 
<a name="414"/>  414:                 {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName,
<a name="415"/>  415:                                                         Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="416"/>  416:                 {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="417"/>  417:                                                         Domain, &quot;\&quot;My Mike\&quot;&quot;, &quot;\'My Group\'&quot;, &quot;both&quot;], Config),
<a name="418"/>  418: 
<a name="419"/>  419:                 [Push1, Push2] = escalus:wait_for_stanzas(Alice, 2), % Check roster broadcasts
<a name="420"/>  420:                 escalus:assert(is_roster_set, Push1),
<a name="421"/>  421:                 escalus:assert(roster_contains, [bob], Push1),
<a name="422"/>  422:                 escalus:assert(is_roster_set, Push2),
<a name="423"/>  423:                 escalus:assert(roster_contains, [mike], Push2),
<a name="424"/>  424: 
<a name="425"/>  425:                 {Items1, 0} = ejabberdctl(&quot;get_roster&quot;, [AliceName, Domain], Config),
<a name="426"/>  426:                 match_roster([{BobName, Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;},
<a name="427"/>  427:                               {MikeName, Domain, &quot;MyMike&quot;, &quot;MyGroup&quot;, &quot;both&quot;}], Items1),
<a name="428"/>  428: 
<a name="429"/>  429:                 escalus:send(Alice, escalus_stanza:roster_get()),
<a name="430"/>  430:                 Roster1 = escalus:wait_for_stanza(Alice),
<a name="431"/>  431:                 escalus:assert(is_roster_result, Roster1),
<a name="432"/>  432:                 escalus:assert(roster_contains, [bob], Roster1),
<a name="433"/>  433:                 escalus:assert(roster_contains, [mike], Roster1),
<a name="434"/>  434: 
<a name="435"/>  435:                 {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, BobName, Domain], Config),
<a name="436"/>  436: 
<a name="437"/>  437:                 Push3 = escalus:wait_for_stanza(Alice),
<a name="438"/>  438:                 escalus:assert(is_roster_set, Push3),
<a name="439"/>  439:                 escalus:assert(roster_contains, [bob], Push3),
<a name="440"/>  440: 
<a name="441"/>  441:                 {Items2, 0} = ejabberdctl(&quot;get_roster&quot;, [AliceName, Domain], Config),
<a name="442"/>  442:                 match_roster([{MikeName, Domain, &quot;MyMike&quot;, &quot;MyGroup&quot;, &quot;both&quot;}], Items2),
<a name="443"/>  443: 
<a name="444"/>  444:                 escalus:send(Alice, escalus_stanza:roster_remove_contact(mike))  % cleanup
<a name="445"/>  445:         end).
<a name="446"/>  446: 
<a name="presence_after_add_rosteritem-1"/><a name="447"/>  447: <b>presence_after_add_rosteritem</b>(Config) -&gt;
<a name="presence_after_add_rosteritem-last_expr"/><a name="448"/>  448: <b>     escalus:story</b>(Config, [{alice, 1}, {bob,1}], fun(Alice, Bob) -&gt;
<a name="449"/>  449:                  {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="450"/>  450:                  {BobName, Domain, _} = get_user_data(bob, Config),
<a name="451"/>  451: 
<a name="452"/>  452:                  {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName,
<a name="453"/>  453:                                                          Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="454"/>  454: 
<a name="455"/>  455:                  escalus:send(Alice, escalus_stanza:presence(&lt;&lt;&quot;available&quot;&gt;&gt;)),
<a name="456"/>  456:                  escalus:assert(is_presence, escalus:wait_for_stanza(Bob)),
<a name="457"/>  457: 
<a name="458"/>  458:                  escalus:send(Alice, escalus_stanza:roster_remove_contact(bob))  % cleanup
<a name="459"/>  459:          end).
<a name="460"/>  460: 
<a name="push_roster-1"/><a name="461"/>  461: <b>push_roster</b>(Config) -&gt;
<a name="push_roster-last_expr"/><a name="462"/>  462: <b>    escalus:story</b>(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="463"/>  463:                 {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="464"/>  464:                 TemplatePath = escalus_config:get_config(roster_template, Config),
<a name="465"/>  465: 
<a name="466"/>  466:                 {_, 0} = ejabberdctl(&quot;push_roster&quot;, [TemplatePath, AliceName, Domain], Config),
<a name="467"/>  467:                 escalus:send(Alice, escalus_stanza:roster_get()),
<a name="468"/>  468:                 Roster1 = escalus:wait_for_stanza(Alice),
<a name="469"/>  469:                 escalus:assert(is_roster_result, Roster1),
<a name="470"/>  470:                 escalus:assert(roster_contains, [bob], Roster1),
<a name="471"/>  471: 
<a name="472"/>  472:                 escalus:send(Alice, escalus_stanza:roster_remove_contact(bob)) % cleanup
<a name="473"/>  473:         end).
<a name="474"/>  474: 
<a name="process_rosteritems_list_simple-1"/><a name="475"/>  475: <b>process_rosteritems_list_simple</b>(Config) -&gt;
<a name="process_rosteritems_list_simple-last_expr"/><a name="476"/>  476: <b>    escalus:story</b>(Config, [{alice, 1}, {bob, 1}], fun(Alice, Bob) -&gt;
<a name="477"/>  477:         %% given
<a name="478"/>  478:         Action = &quot;list&quot;,
<a name="479"/>  479:         Subs = &quot;any&quot;,
<a name="480"/>  480:         Asks = &quot;any&quot;,
<a name="481"/>  481:         User = escalus_client:short_jid(Alice),
<a name="482"/>  482:         Contact =string:to_lower(binary_to_list(escalus_client:short_jid(Bob))),
<a name="483"/>  483:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="484"/>  484:         {BobName, Domain, _} = get_user_data(bob, Config),
<a name="485"/>  485:         %% when
<a name="486"/>  486:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName, Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="487"/>  487:         S = escalus:wait_for_stanzas(Alice, 2),
<a name="488"/>  488:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, Contact], Config),
<a name="489"/>  489:         %% then
<a name="490"/>  490:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++Contact++&quot;.*&quot;),
<a name="491"/>  491:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, BobName, Domain], Config)
<a name="492"/>  492:     end).
<a name="493"/>  493: 
<a name="process_rosteritems_list_nomatch-1"/><a name="494"/>  494: <b>process_rosteritems_list_nomatch</b>(Config) -&gt;
<a name="process_rosteritems_list_nomatch-last_expr"/><a name="495"/>  495: <b>    escalus:story</b>(Config, [{alice, 1}, {bob, 1}], fun(Alice, Bob) -&gt;
<a name="496"/>  496:         %% given
<a name="497"/>  497:         Action = &quot;list&quot;,
<a name="498"/>  498:         Subs = &quot;from:both&quot;,
<a name="499"/>  499:         Asks = &quot;any&quot;,
<a name="500"/>  500:         User = escalus_client:short_jid(Alice),
<a name="501"/>  501:         Contact =string:to_lower(binary_to_list(escalus_client:short_jid(Bob))),
<a name="502"/>  502:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="503"/>  503:         {BobName, Domain, _} = get_user_data(bob, Config),
<a name="504"/>  504:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName,
<a name="505"/>  505:                                                 Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;to&quot;], Config),
<a name="506"/>  506:         escalus:wait_for_stanzas(Alice, 2),
<a name="507"/>  507:         %% when
<a name="508"/>  508:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, Contact], Config),
<a name="509"/>  509:         %% then
<a name="510"/>  510:         nomatch = re:run(R, &quot;.*Matches:.*&quot;++Contact++&quot;.*&quot;),
<a name="511"/>  511:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, BobName, Domain], Config)
<a name="512"/>  512:     end).
<a name="513"/>  513: 
<a name="process_rosteritems_list_advanced1-1"/><a name="514"/>  514: <b>process_rosteritems_list_advanced1</b>(Config) -&gt;
<a name="process_rosteritems_list_advanced1-last_expr"/><a name="515"/>  515: <b>    escalus:story</b>(Config, [{alice, 1}, {mike, 1}, {kate, 1}], fun(Alice, Mike, Kate) -&gt;
<a name="516"/>  516:         %% given
<a name="517"/>  517:         Action = &quot;list&quot;,
<a name="518"/>  518:         Subs = &quot;from:both&quot;,
<a name="519"/>  519:         Asks = &quot;any&quot;,
<a name="520"/>  520:         User = escalus_client:short_jid(Alice),
<a name="521"/>  521:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="522"/>  522:         {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="523"/>  523:         {KateName, Domain, _} = get_user_data(kate, Config),
<a name="524"/>  524:         ContactMike = string:to_lower(binary_to_list(escalus_client:short_jid(Mike))),
<a name="525"/>  525:         ContactKate= string:to_lower(binary_to_list(escalus_client:short_jid(Kate))),
<a name="526"/>  526:         ContactsRegexp = ContactMike ++ &quot;:&quot; ++ string:substr(binary_to_list(KateName), 1, 2) ++ &quot;.*@.*&quot;,
<a name="527"/>  527: 
<a name="528"/>  528:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="529"/>  529:                                                 Domain, &quot;DearMike&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="530"/>  530:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, KateName,
<a name="531"/>  531:                                                 Domain, &quot;BestFriend&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="532"/>  532:         escalus:wait_for_stanzas(Alice,4),
<a name="533"/>  533:         %% when
<a name="534"/>  534:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, ContactsRegexp], Config),
<a name="535"/>  535:         %% then
<a name="536"/>  536:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactMike++&quot;.*&quot;),
<a name="537"/>  537:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactKate++&quot;.*&quot;),
<a name="538"/>  538:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, MikeName, Domain], Config),
<a name="539"/>  539:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, KateName, Domain], Config)
<a name="540"/>  540:     end).
<a name="541"/>  541: 
<a name="process_rosteritems_delete_advanced-1"/><a name="542"/>  542: <b>process_rosteritems_delete_advanced</b>(Config) -&gt;
<a name="process_rosteritems_delete_advanced-last_expr"/><a name="543"/>  543: <b>    escalus:story</b>(Config, [{alice, 1}, {mike, 1}, {kate, 1}], fun(Alice, Mike, Kate) -&gt;
<a name="544"/>  544:         %% given
<a name="545"/>  545:         Action = &quot;delete&quot;,
<a name="546"/>  546:         Subs = &quot;from&quot;,
<a name="547"/>  547:         Asks = &quot;any&quot;,
<a name="548"/>  548:         User = escalus_client:short_jid(Alice),
<a name="549"/>  549:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="550"/>  550:         {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="551"/>  551:         {KateName, Domain, _} = get_user_data(kate, Config),
<a name="552"/>  552:         ContactMike = string:to_lower(binary_to_list(escalus_client:short_jid(Mike))),
<a name="553"/>  553:         ContactKate= string:to_lower(binary_to_list(escalus_client:short_jid(Kate))),
<a name="554"/>  554:         ContactsRegexp = &quot;.*&quot; ++ string:substr(ContactMike, 3) ++
<a name="555"/>  555:                            &quot;:&quot; ++ string:substr(ContactKate, 1,2) ++&quot;@&quot; ++ binary_to_list(Domain),
<a name="556"/>  556:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="557"/>  557:                                                 Domain, &quot;DearMike&quot;, &quot;MyGroup&quot;, &quot;from&quot;], Config),
<a name="558"/>  558:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, KateName,
<a name="559"/>  559:                                                 Domain, &quot;Friend&quot;, &quot;MyGroup&quot;, &quot;from&quot;], Config),
<a name="560"/>  560:         escalus:wait_for_stanzas(Alice,4),
<a name="561"/>  561:         %% when
<a name="562"/>  562:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, ContactsRegexp], Config),
<a name="563"/>  563:         %% then
<a name="564"/>  564:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactMike++&quot;.*&quot;),
<a name="565"/>  565:         nomatch = re:run(R, &quot;.*Matches:.*&quot;++ContactKate++&quot;.*&quot;),
<a name="566"/>  566:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, MikeName, Domain], Config),
<a name="567"/>  567:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, KateName, Domain], Config)
<a name="568"/>  568:     end).
<a name="569"/>  569: 
<a name="process_rosteritems_list_advanced2-1"/><a name="570"/>  570: <b>process_rosteritems_list_advanced2</b>(Config) -&gt;
<a name="process_rosteritems_list_advanced2-last_expr"/><a name="571"/>  571: <b>    escalus:story</b>(Config, [{alice, 1}, {mike, 1}, {kate, 1}], fun(Alice, Mike, Kate) -&gt;
<a name="572"/>  572:         %% given
<a name="573"/>  573:         Action = &quot;list&quot;,
<a name="574"/>  574:         Subs = &quot;any&quot;,
<a name="575"/>  575:         Asks = &quot;any&quot;,
<a name="576"/>  576:         User = escalus_client:short_jid(Alice),
<a name="577"/>  577:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="578"/>  578:         {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="579"/>  579:         {KateName, Domain, _} = get_user_data(kate, Config),
<a name="580"/>  580:         ContactMike = string:to_lower(binary_to_list(escalus_client:short_jid(Mike))),
<a name="581"/>  581:         ContactKate= string:to_lower(binary_to_list(escalus_client:short_jid(Kate))),
<a name="582"/>  582:         ContactsRegexp = &quot;.*e@lo.*&quot;,
<a name="583"/>  583:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="584"/>  584:                                                 Domain, &quot;DearMike&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="585"/>  585:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, KateName,
<a name="586"/>  586:                                                 Domain, &quot;KateFromSchool&quot;, &quot;MyGroup&quot;, &quot;from&quot;], Config),
<a name="587"/>  587:         escalus:wait_for_stanzas(Alice,4),
<a name="588"/>  588:         %% when
<a name="589"/>  589:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, ContactsRegexp], Config),
<a name="590"/>  590:         %% then
<a name="591"/>  591:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactMike++&quot;.*&quot;),
<a name="592"/>  592:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactKate++&quot;.*&quot;),
<a name="593"/>  593:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, MikeName, Domain], Config),
<a name="594"/>  594:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, KateName, Domain], Config)
<a name="595"/>  595:     end).
<a name="596"/>  596: 
<a name="process_rosteritems_delete_advanced2-1"/><a name="597"/>  597: <b>process_rosteritems_delete_advanced2</b>(Config) -&gt;
<a name="process_rosteritems_delete_advanced2-last_expr"/><a name="598"/>  598: <b>    escalus:story</b>(Config, [{alice, 1}, {bob, 1}, {mike, 1}, {kate, 1}], fun(Alice, Bob, Mike, Kate) -&gt;
<a name="599"/>  599:         %% given
<a name="600"/>  600:         Action = &quot;delete&quot;,
<a name="601"/>  601:         Subs = &quot;to:from&quot;,
<a name="602"/>  602:         Asks = &quot;any&quot;,
<a name="603"/>  603:         User = &quot;'al.c[e]@.*host:((b[o]b)|(mike))@loc.*t2'&quot;,
<a name="604"/>  604:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="605"/>  605:         {BobName, Domain, _} = get_user_data(bob, Config),
<a name="606"/>  606:         {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="607"/>  607:         {KateName, Domain, _} = get_user_data(kate, Config),
<a name="608"/>  608:         ContactMike = string:to_lower(binary_to_list(escalus_client:short_jid(Mike))),
<a name="609"/>  609:         ContactKate= string:to_lower(binary_to_list(escalus_client:short_jid(Kate))),
<a name="610"/>  610:         ContactBob= string:to_lower(binary_to_list(escalus_client:short_jid(Bob))),
<a name="611"/>  611:         ContactsReg = &quot;'.ik[ea]@localho+.*:k@loc.*st:(alice)+@.*:no'&quot;,
<a name="612"/>  612:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="613"/>  613:                                                 Domain, &quot;DearMike&quot;, &quot;MyGroup&quot;, &quot;to&quot;], Config),
<a name="614"/>  614:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, KateName,
<a name="615"/>  615:                                                 Domain, &quot;HateHerSheHasSoNiceLegs&quot;, &quot;MyGroup&quot;, &quot;to&quot;], Config),
<a name="616"/>  616:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [BobName, Domain, AliceName,
<a name="617"/>  617:                                                 Domain, &quot;Girlfriend&quot;, &quot;MyGroup&quot;, &quot;from&quot;], Config),
<a name="618"/>  618:         escalus:wait_for_stanzas(Alice,4),
<a name="619"/>  619:         escalus:wait_for_stanzas(Bob, 2),
<a name="620"/>  620:         %% when
<a name="621"/>  621:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, ContactsReg], Config),
<a name="622"/>  622:         %% then
<a name="623"/>  623:         {match, _} = re:run(R, &quot;.*Matches:.*&quot; ++ ContactMike ++ &quot;.*&quot;),
<a name="624"/>  624:         nomatch = re:run(R, &quot;.*Matches:.*&quot; ++ ContactKate ++ &quot;.*&quot;),
<a name="625"/>  625:         nomatch = re:run(R, &quot;.*Matches:.*&quot; ++ ContactBob ++ &quot;.*&quot;),
<a name="626"/>  626:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, MikeName, Domain], Config),
<a name="627"/>  627:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, KateName, Domain], Config),
<a name="628"/>  628:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [BobName, Domain, AliceName, Domain], Config)
<a name="629"/>  629:     end).
<a name="630"/>  630: 
<a name="push_roster_all-1"/><a name="631"/>  631: <b>push_roster_all</b>(Config) -&gt;
<a name="push_roster_all-last_expr"/><a name="632"/>  632: <b>    escalus:story</b>(Config, [{alice, 1}, {bob,1}], fun(Alice, Bob) -&gt;
<a name="633"/>  633:                 TemplatePath = escalus_config:get_config(roster_template, Config),
<a name="634"/>  634: 
<a name="635"/>  635:                 {_, 0} = ejabberdctl(&quot;push_roster_all&quot;, [TemplatePath], Config),
<a name="636"/>  636: 
<a name="637"/>  637:                 escalus:send(Alice, escalus_stanza:roster_get()),
<a name="638"/>  638:                 Roster1 = escalus:wait_for_stanza(Alice),
<a name="639"/>  639:                 escalus:assert(is_roster_result, Roster1),
<a name="640"/>  640:                 escalus:assert(roster_contains, [bob], Roster1),
<a name="641"/>  641: 
<a name="642"/>  642:                 escalus:send(Bob, escalus_stanza:roster_get()),
<a name="643"/>  643:                 Roster2 = escalus:wait_for_stanza(Bob),
<a name="644"/>  644:                 escalus:assert(is_roster_result, Roster2),
<a name="645"/>  645:                 escalus:assert(roster_contains, [alice], Roster2),
<a name="646"/>  646: 
<a name="647"/>  647:                 escalus:send(Alice, escalus_stanza:roster_remove_contact(bob)), % cleanup
<a name="648"/>  648:                 escalus:send(Bob, escalus_stanza:roster_remove_contact(alice)) % cleanup
<a name="649"/>  649:         end).
<a name="650"/>  650: 
<a name="push_roster_alltoall-1"/><a name="651"/>  651: <b>push_roster_alltoall</b>(Config) -&gt;
<a name="push_roster_alltoall-last_expr"/><a name="652"/>  652: <b>    escalus:story</b>(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="653"/>  653:                 {_, Domain, _} = get_user_data(alice, Config),
<a name="654"/>  654: 
<a name="655"/>  655:                 {_, 0} = ejabberdctl(&quot;push_roster_alltoall&quot;, [Domain, &quot;MyGroup&quot;], Config),
<a name="656"/>  656: 
<a name="657"/>  657:                 escalus:send(Alice, escalus_stanza:roster_get()),
<a name="658"/>  658:                 Roster = escalus:wait_for_stanza(Alice),
<a name="659"/>  659: 
<a name="660"/>  660:                 escalus:assert(is_roster_result, Roster),
<a name="661"/>  661:                 escalus:assert(roster_contains, [bob], Roster),
<a name="662"/>  662:                 escalus:assert(roster_contains, [mike], Roster),
<a name="663"/>  663:                 escalus:assert(roster_contains, [kate], Roster)
<a name="664"/>  664:         end).
<a name="665"/>  665: 
<a name="666"/>  666: <i>%%--------------------------------------------------------------------</i>
<a name="667"/>  667: <i>%% mod_admin_extra_last tests</i>
<a name="668"/>  668: <i>%%--------------------------------------------------------------------</i>
<a name="669"/>  669: 
<a name="set_last-1"/><a name="670"/>  670: <b>set_last</b>(Config) -&gt;
<a name="set_last-last_expr"/><a name="671"/>  671: <b>    escalus:story</b>(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="672"/>  672:                 {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="673"/>  673:                 {BobName, Domain, _} = get_user_data(bob, Config),
<a name="674"/>  674: 
<a name="675"/>  675:                 {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName,
<a name="676"/>  676:                                                         Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="677"/>  677:                 {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [BobName, Domain, AliceName,
<a name="678"/>  678:                                                         Domain, &quot;MyAlice&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="679"/>  679: 
<a name="680"/>  680:                 escalus:wait_for_stanza(Alice), % ignore push
<a name="681"/>  681: 
<a name="682"/>  682:                 {Mega, Secs, _} = erlang:now(),
<a name="683"/>  683:                 TS = integer_to_list(Mega*1000000+Secs-7200),
<a name="684"/>  684: 
<a name="685"/>  685:                 {_, 0} = ejabberdctl(&quot;set_last&quot;, [BobName, Domain, TS, &quot;Status&quot;], Config),
<a name="686"/>  686: 
<a name="687"/>  687:                 escalus:send(Alice, escalus_stanza:last_activity(bob)),
<a name="688"/>  688:                 LastAct = escalus:wait_for_stanza(Alice),
<a name="689"/>  689:                 escalus:assert(is_last_result, LastAct),
<a name="690"/>  690:                 Seconds = list_to_integer(binary_to_list(
<a name="691"/>  691:                             exml_query:path(LastAct, [{element, &lt;&lt;&quot;query&quot;&gt;&gt;}, {attr, &lt;&lt;&quot;seconds&quot;&gt;&gt;}]))),
<a name="692"/>  692:                 true = ( (Seconds &gt; 7100) andalso (Seconds &lt; 7300) ),
<a name="693"/>  693: 
<a name="694"/>  694:                 {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, BobName, Domain], Config), % cleanup
<a name="695"/>  695:                 {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [BobName, Domain, AliceName, Domain], Config)
<a name="696"/>  696:         end).
<a name="697"/>  697: 
<a name="698"/>  698: <i>%%--------------------------------------------------------------------</i>
<a name="699"/>  699: <i>%% mod_admin_extra_private tests</i>
<a name="700"/>  700: <i>%%--------------------------------------------------------------------</i>
<a name="701"/>  701: 
<a name="private_rw-1"/><a name="702"/>  702: <b>private_rw</b>(Config) -&gt;
<a name="703"/>  703:     {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="704"/>  704:     XmlEl1 = &quot;'&lt;secretinfo xmlns=\&quot;nejmspejs\&quot;&gt;1&lt;/secretinfo&gt;'&quot;,
<a name="705"/>  705:     XmlEl2 = &quot;'&lt;secretinfo xmlns=\&quot;inny\&quot;&gt;2&lt;/secretinfo&gt;'&quot;,
<a name="706"/>  706: 
<a name="707"/>  707:     {_, 0} = ejabberdctl(&quot;private_set&quot;, [AliceName, Domain, XmlEl1], Config),
<a name="708"/>  708:     {_, 0} = ejabberdctl(&quot;private_set&quot;, [AliceName, Domain, XmlEl2], Config),
<a name="709"/>  709: 
<a name="710"/>  710:     {Result, 0} = ejabberdctl(&quot;private_get&quot;, [AliceName, Domain, &quot;secretinfo&quot;, &quot;nejmspejs&quot;], Config),
<a name="711"/>  711:     {ok, #xmlel{ name = &lt;&lt;&quot;secretinfo&quot;&gt;&gt;, attrs = [{&lt;&lt;&quot;xmlns&quot;&gt;&gt;, &lt;&lt;&quot;nejmspejs&quot;&gt;&gt;}],
<a name="private_rw-last_expr"/><a name="712"/>  712: <b>                children = [#xmlcdata{ content = &lt;&lt;&quot;1&quot;&gt;&gt; }]}} = exml:parse</b>(list_to_binary(Result)).
<a name="713"/>  713: 
<a name="714"/>  714: <i>%%--------------------------------------------------------------------</i>
<a name="715"/>  715: <i>%% mod_admin_extra_stanza tests</i>
<a name="716"/>  716: <i>%%--------------------------------------------------------------------</i>
<a name="717"/>  717: 
<a name="send_message-1"/><a name="718"/>  718: <b>send_message</b>(Config) -&gt;
<a name="send_message-last_expr"/><a name="719"/>  719: <b>    escalus:story</b>(Config, [{alice, 1}, {bob, 2}], fun(Alice, Bob1, Bob2) -&gt;
<a name="720"/>  720:                 {_, 0} = ejabberdctl(&quot;send_message_chat&quot;, [escalus_client:full_jid(Alice),
<a name="721"/>  721:                                                            escalus_client:full_jid(Bob1),
<a name="722"/>  722:                                                            &quot;\&quot;Hi Bob!\&quot;&quot;], Config),
<a name="723"/>  723:                 Stanza1 = escalus:wait_for_stanza(Bob1),
<a name="724"/>  724:                 escalus:assert(is_chat_message, [&lt;&lt;&quot;Hi Bob!&quot;&gt;&gt;], Stanza1),
<a name="725"/>  725: 
<a name="726"/>  726:                 {_, 0} = ejabberdctl(&quot;send_message_headline&quot;, [escalus_client:full_jid(Alice),
<a name="727"/>  727:                                                                     escalus_client:short_jid(Bob1),
<a name="728"/>  728:                                                                     &quot;Subj&quot;, &quot;\&quot;Hi Bob!!\&quot;&quot;], Config),
<a name="729"/>  729:                 Stanza2 = escalus:wait_for_stanza(Bob1),
<a name="730"/>  730:                 Stanza3 = escalus:wait_for_stanza(Bob2),
<a name="731"/>  731:                 escalus:assert(is_headline_message, [&lt;&lt;&quot;Subj&quot;&gt;&gt;, &lt;&lt;&quot;Hi Bob!!&quot;&gt;&gt;], Stanza2),
<a name="732"/>  732:                 escalus:assert(is_headline_message, [&lt;&lt;&quot;Subj&quot;&gt;&gt;, &lt;&lt;&quot;Hi Bob!!&quot;&gt;&gt;], Stanza3)
<a name="733"/>  733:         end).
<a name="734"/>  734: 
<a name="send_message_wrong_jid-1"/><a name="735"/>  735: <b>send_message_wrong_jid</b>(Config) -&gt;
<a name="send_message_wrong_jid-last_expr"/><a name="736"/>  736: <b>    escalus:story</b>(Config, [{alice, 1}, {bob, 1}], fun(Alice, Bob) -&gt;
<a name="737"/>  737:         {_, Err1} = ejabberdctl(&quot;send_message_chat&quot;, [&quot;'@@#$%!!.'&quot;,
<a name="738"/>  738:                                                    escalus_client:full_jid(Bob),
<a name="739"/>  739:                                                    &quot;\&quot;Hello bobby!\&quot;&quot;], Config),
<a name="740"/>  740:         {_, Err2} = ejabberdctl(&quot;send_message_headline&quot;, [&quot;'%%@&amp;@&amp;@==//\///'&quot;,
<a name="741"/>  741:                                                        escalus_client:short_jid(Bob),
<a name="742"/>  742:                                                        &quot;Subj&quot;, &quot;\&quot;Are
<a name="743"/>  743:                                                        you there?\&quot;&quot;],
<a name="744"/>  744:                              Config),
<a name="745"/>  745:         true = Err1 =/= 0,
<a name="746"/>  746:         true = Err2 =/= 0,
<a name="747"/>  747:         escalus_assert:has_no_stanzas(Alice),
<a name="748"/>  748:         escalus_assert:has_no_stanzas(Bob)
<a name="749"/>  749:     end).
<a name="750"/>  750: 
<a name="send_stanza-1"/><a name="751"/>  751: <b>send_stanza</b>(Config) -&gt;
<a name="send_stanza-last_expr"/><a name="752"/>  752: <b>    escalus:story</b>(Config, [{alice, 1}, {bob,1}], fun(Alice, Bob) -&gt;
<a name="753"/>  753:                 Domain = escalus_client:server(Alice),
<a name="754"/>  754:                 Resource = escalus_client:resource(Alice),
<a name="755"/>  755:                 {BobName, _, _} = get_user_data(bob, Config),
<a name="756"/>  756:                 BobJID = &lt;&lt;BobName/binary, $@, Domain/binary, $/, (escalus_client:resource(Bob))/binary&gt;&gt;,
<a name="757"/>  757: 
<a name="758"/>  758:                 Stanza = re:replace(exml:to_binary(escalus_stanza:from(escalus_stanza:chat_to(Alice, &quot;Hi&quot;), BobJID)),
<a name="759"/>  759:                                     &lt;&lt;?DOUBLE_QUOTE_CHAR&gt;&gt;, &lt;&lt;?SINGLE_QUOTE_CHAR&gt;&gt;, [global, {return, binary}]),
<a name="760"/>  760:                 {_, 0} = ejabberdctl(&quot;send_stanza_c2s&quot;, [BobName, Domain, Resource, &lt;&lt;$\&quot;, Stanza/binary, $\&quot;&gt;&gt;], Config),
<a name="761"/>  761: 
<a name="762"/>  762:                 Message = escalus:wait_for_stanza(Alice),
<a name="763"/>  763:                 escalus:assert(is_chat_message, [&lt;&lt;&quot;Hi&quot;&gt;&gt;], Message),
<a name="764"/>  764:                 escalus:assert(is_stanza_from, [Bob], Message)
<a name="765"/>  765:         end).
<a name="766"/>  766: 
<a name="send_stanzac2s_wrong-1"/><a name="767"/>  767: <b>send_stanzac2s_wrong</b>(Config) -&gt;
<a name="send_stanzac2s_wrong-last_expr"/><a name="768"/>  768: <b>    escalus:story</b>(Config, [{alice, 1}, {bob,1}], fun(Alice, Bob) -&gt;
<a name="769"/>  769:         Domain = escalus_client:server(Alice),
<a name="770"/>  770:         Resource = escalus_client:resource(Alice),
<a name="771"/>  771:         WrongBobName = &quot;bobby_the_great&quot;,
<a name="772"/>  772:         {BobName, _, _} = get_user_data(bob, Config),
<a name="773"/>  773:         BobJID = &lt;&lt;BobName/binary, $@, Domain/binary, $/, (escalus_client:resource(Bob))/binary&gt;&gt;,
<a name="774"/>  774:         Stanza = re:replace(exml:to_binary(escalus_stanza:from(escalus_stanza:chat_to(Alice, &quot;Hi&quot;), BobJID)),
<a name="775"/>  775:                             &lt;&lt;?DOUBLE_QUOTE_CHAR&gt;&gt;, &lt;&lt;?SINGLE_QUOTE_CHAR&gt;&gt;, [global, {return, binary}]),
<a name="776"/>  776:         StanzaWrong = &lt;&lt;&quot;&lt;iq type='get' id='234234'&gt;&lt;xmlns='wrongwrong'&gt;&quot;&gt;&gt;,
<a name="777"/>  777:         {_, Err} = ejabberdctl(&quot;send_stanza_c2s&quot;, [WrongBobName, Domain, Resource, &lt;&lt;$\&quot;, Stanza/binary, $\&quot;&gt;&gt;],
<a name="778"/>  778:                                Config),
<a name="779"/>  779:         {_, Err2} = ejabberdctl(&quot;send_stanza_c2s&quot;, [BobName, Domain, Resource, &lt;&lt;$\&quot;, StanzaWrong/binary, $\&quot;&gt;&gt;],
<a name="780"/>  780:                                Config),
<a name="781"/>  781: 
<a name="782"/>  782:         true = Err =/= 0,
<a name="783"/>  783:         true = Err2 =/= 0,
<a name="784"/>  784:         escalus_assert:has_no_stanzas(Alice)
<a name="785"/>  785:     end).
<a name="786"/>  786: 
<a name="787"/>  787: <i>%%--------------------------------------------------------------------</i>
<a name="788"/>  788: <i>%% mod_admin_extra_stats tests</i>
<a name="789"/>  789: <i>%%--------------------------------------------------------------------</i>
<a name="790"/>  790: 
<a name="stats_global-1"/><a name="791"/>  791: <b>stats_global</b>(Config) -&gt;
<a name="stats_global-last_expr"/><a name="792"/>  792: <b>    escalus:story</b>(Config, [{alice, 1}, {bob,1}], fun(_Alice, _Bob) -&gt;
<a name="793"/>  793:                 RegisteredCount = length(escalus_config:get_config(escalus_users, Config, [])),
<a name="794"/>  794:                 Registered = integer_to_list(RegisteredCount) ++ &quot;\n&quot;,
<a name="795"/>  795: 
<a name="796"/>  796:                 {UpTime, 0} = ejabberdctl(&quot;stats&quot;, [&quot;uptimeseconds&quot;], Config),
<a name="797"/>  797:                 _ = list_to_integer(string:strip(UpTime, both, $\n)),
<a name="798"/>  798:                 {Registered, 0} = ejabberdctl(&quot;stats&quot;, [&quot;registeredusers&quot;], Config),
<a name="799"/>  799: 
<a name="800"/>  800:                 {&quot;2\n&quot;, 0} = ejabberdctl(&quot;stats&quot;, [&quot;onlineusersnode&quot;], Config),
<a name="801"/>  801: 
<a name="802"/>  802:                 {&quot;2\n&quot;, 0} = ejabberdctl(&quot;stats&quot;, [&quot;onlineusers&quot;], Config)
<a name="803"/>  803:         end).
<a name="804"/>  804: 
<a name="stats_host-1"/><a name="805"/>  805: <b>stats_host</b>(Config) -&gt;
<a name="stats_host-last_expr"/><a name="806"/>  806: <b>    escalus:story</b>(Config, [{alice, 1}, {bob,1}], fun(Alice, _Bob) -&gt;
<a name="807"/>  807:                 RegisteredCount = length(escalus_config:get_config(escalus_users, Config, [])),
<a name="808"/>  808:                 Registered = integer_to_list(RegisteredCount) ++ &quot;\n&quot;,
<a name="809"/>  809: 
<a name="810"/>  810:                 PriDomain = escalus_client:server(Alice),
<a name="811"/>  811:                 SecDomain = escalus_config:get_config(ejabberd_secondary_domain, Config),
<a name="812"/>  812: 
<a name="813"/>  813:                 {Registered, 0} = ejabberdctl(&quot;stats_host&quot;, [&quot;registeredusers&quot;, PriDomain], Config),
<a name="814"/>  814:                 {&quot;0\n&quot;, 0} = ejabberdctl(&quot;stats_host&quot;, [&quot;registeredusers&quot;, SecDomain], Config),
<a name="815"/>  815: 
<a name="816"/>  816:                 {&quot;2\n&quot;, 0} = ejabberdctl(&quot;stats_host&quot;, [&quot;onlineusers&quot;, PriDomain], Config),
<a name="817"/>  817:                 {&quot;0\n&quot;, 0} = ejabberdctl(&quot;stats_host&quot;, [&quot;onlineusers&quot;, SecDomain], Config)
<a name="818"/>  818:         end).
<a name="819"/>  819: 
<a name="820"/>  820: 
<a name="821"/>  821: 
<a name="822"/>  822: <i>%%-----------------------------------------------------------------</i>
<a name="823"/>  823: <i>%% Improve coverage</i>
<a name="824"/>  824: <i>%%-----------------------------------------------------------------</i>
<a name="825"/>  825: 
<a name="826"/>  826: 
<a name="827"/>  827: 
<a name="simple_register-1"/><a name="828"/>  828: <b>simple_register</b>(Config) -&gt;
<a name="829"/>  829:     %% given
<a name="830"/>  830:     Domain = escalus_ct:get_config(ejabberd_domain),
<a name="831"/>  831:     {Name, Password} = {&lt;&lt;&quot;tyler&quot;&gt;&gt;, &lt;&lt;&quot;durden&quot;&gt;&gt;},
<a name="832"/>  832:     %% when
<a name="833"/>  833:     {_, 0} = ejabberdctl(&quot;register&quot;, [Name, Domain, Password], Config),
<a name="834"/>  834:     {R2, 0} = ejabberdctl(&quot;registered_users&quot;, [Domain], Config),
<a name="835"/>  835:     %% then
<a name="simple_register-last_expr"/><a name="836"/>  836: <b>    {match, _} = re:run</b>(R2, &quot;.*(&quot; ++binary_to_list(Name)++&quot;).*&quot;).
<a name="837"/>  837: 
<a name="simple_unregister-1"/><a name="838"/>  838: <b>simple_unregister</b>(Config) -&gt;
<a name="839"/>  839:     %% given
<a name="840"/>  840:     Domain = escalus_ct:get_config(ejabberd_domain),
<a name="841"/>  841:     {Name, _} = {&lt;&lt;&quot;tyler&quot;&gt;&gt;, &lt;&lt;&quot;durden&quot;&gt;&gt;},
<a name="842"/>  842:     %% when
<a name="843"/>  843:     {_, 0} = ejabberdctl(&quot;unregister&quot;, [Name, Domain], Config),
<a name="844"/>  844:     {R2, 0} = ejabberdctl(&quot;registered_users&quot;, [Domain], Config),
<a name="845"/>  845:     %% then
<a name="simple_unregister-last_expr"/><a name="846"/>  846: <b>    nomatch = re:run</b>(R2, &quot;.*(&quot; ++binary_to_list(Name)++&quot;).*&quot;).
<a name="847"/>  847: 
<a name="register_twice-1"/><a name="848"/>  848: <b>register_twice</b>(Config) -&gt;
<a name="849"/>  849:     %% given
<a name="850"/>  850:     Domain = escalus_ct:get_config(ejabberd_domain),
<a name="851"/>  851:     {Name,  Password} = {&lt;&lt;&quot;tyler&quot;&gt;&gt;, &lt;&lt;&quot;durden&quot;&gt;&gt;},
<a name="852"/>  852:     %% when
<a name="853"/>  853:     {_, 0} = ejabberdctl(&quot;register&quot;, [Name, Domain, Password], Config),
<a name="854"/>  854:     {R, Code} = ejabberdctl(&quot;register&quot;, [Name, Domain, Password], Config),
<a name="855"/>  855:     %% then
<a name="856"/>  856:     {match, _} = re:run(R, &quot;.*(already registered).*&quot;),
<a name="857"/>  857:     true = (Code =/= 0),
<a name="register_twice-last_expr"/><a name="858"/>  858: <b>    {_, 0} = ejabberdctl</b>(&quot;unregister&quot;, [Name, Domain], Config).
<a name="859"/>  859: 
<a name="860"/>  860: 
<a name="861"/>  861: 
<a name="backup_restore_mnesia-1"/><a name="862"/>  862: <b>backup_restore_mnesia</b>(Config) -&gt;
<a name="863"/>  863:     %% given
<a name="864"/>  864:     TableName = passwd,
<a name="865"/>  865:     TableSize = rpc_call(mnesia, table_info, [TableName, size]),
<a name="866"/>  866:     io:format(&quot;Table size is ~n~p~n&quot;, [TableSize]),
<a name="867"/>  867:     %% Table passwd should not be empty
<a name="868"/>  868:     FileName = &quot;backup_mnesia.bup&quot;,
<a name="869"/>  869:     %% when
<a name="870"/>  870:     {R, 0} = ejabberdctl(&quot;backup&quot;, [FileName], Config),
<a name="871"/>  871:     nomatch = re:run(R, &quot;.+&quot;),
<a name="872"/>  872:     rpc_call(mnesia, clear_table, [TableName]),
<a name="873"/>  873:     0 = rpc_call(mnesia, table_info, [TableName, size]),
<a name="874"/>  874:     {R2, 0} = ejabberdctl(&quot;restore&quot;, [FileName], Config),
<a name="875"/>  875:     %% then
<a name="876"/>  876:     nomatch = re:run(R2, &quot;.+&quot;),
<a name="backup_restore_mnesia-last_expr"/><a name="877"/>  877: <b>    TableSize = rpc_call</b>(mnesia, table_info, [TableName, size]).
<a name="878"/>  878: 
<a name="restore_mnesia_wrong-1"/><a name="879"/>  879: <b>restore_mnesia_wrong</b>(Config) -&gt;
<a name="880"/>  880:     FileName = &quot;file that doesnt exist13123.bup&quot;,
<a name="881"/>  881:     {R2, _} = ejabberdctl(&quot;restore&quot;, [FileName], Config),
<a name="882"/>  882:     {match, Code} = re:run(R2, &quot;.+&quot;),
<a name="restore_mnesia_wrong-last_expr"/><a name="883"/>  883: <b>    true = </b>(Code =/= 0).
<a name="884"/>  884: 
<a name="dump_and_load-1"/><a name="885"/>  885: <b>dump_and_load</b>(Config) -&gt;
<a name="886"/>  886:     FileName = &quot;dump.bup&quot;,
<a name="887"/>  887:     TableName = passwd,
<a name="888"/>  888:     %% Table passwd should not be empty
<a name="889"/>  889:     TableSize = rpc_call(mnesia, table_info, [TableName, size]),
<a name="890"/>  890:     {_, 0} = ejabberdctl(&quot;dump&quot;, [FileName], Config),
<a name="891"/>  891:     rpc_call(mnesia, clear_table, [TableName]),
<a name="892"/>  892:     0 = rpc_call(mnesia, table_info, [TableName, size]),
<a name="893"/>  893:     {R, 0} = ejabberdctl(&quot;load&quot;, [FileName], Config),
<a name="894"/>  894:     {match, _} = re:run(R, &quot;.+&quot;),
<a name="dump_and_load-last_expr"/><a name="895"/>  895: <b>    TableSize = rpc_call</b>(mnesia, table_info, [TableName, size]).
<a name="896"/>  896: 
<a name="load_mnesia_wrong-1"/><a name="897"/>  897: <b>load_mnesia_wrong</b>(Config) -&gt;
<a name="898"/>  898:     FileName = &quot;file that doesnt existRHCP.bup&quot;,
<a name="899"/>  899:     {R2, Code} = ejabberdctl(&quot;restore&quot;, [FileName], Config),
<a name="900"/>  900:     {match, _} = re:run(R2, &quot;.+&quot;),
<a name="load_mnesia_wrong-last_expr"/><a name="901"/>  901: <b>    true = </b>(Code =/= 0).
<a name="902"/>  902: 
<a name="dump_table-1"/><a name="903"/>  903: <b>dump_table</b>(Config) -&gt;
<a name="904"/>  904:     FileName = &quot;dump.mn&quot;,
<a name="905"/>  905:     TableName = passwd,
<a name="906"/>  906:     %% Table passwd should not be empty
<a name="907"/>  907:     TableSize = rpc_call(mnesia, table_info, [TableName, size]),
<a name="908"/>  908:     {_, 0} = ejabberdctl(&quot;dump_table&quot;, [FileName, atom_to_list(TableName)], Config),
<a name="909"/>  909:     rpc_call(mnesia, clear_table, [TableName]),
<a name="910"/>  910:     0 = rpc_call(mnesia, table_info, [TableName, size]),
<a name="911"/>  911:     {R, 0} = ejabberdctl(&quot;load&quot;, [FileName], Config),
<a name="912"/>  912:     {match, _} = re:run(R, &quot;.+&quot;),
<a name="dump_table-last_expr"/><a name="913"/>  913: <b>    TableSize = rpc_call</b>(mnesia, table_info, [TableName, size]).
<a name="914"/>  914: 
<a name="get_loglevel-1"/><a name="915"/>  915: <b>get_loglevel</b>(Config) -&gt;
<a name="916"/>  916:     {R, 0} = ejabberdctl(&quot;get_loglevel&quot;, [], Config),
<a name="917"/>  917:     LogLevel = rpc_call(ejabberd_loglevel, get, []),
<a name="918"/>  918:     RegList = [io_lib:format(&quot;(.|\n|\r)*loglevel for ~p is ~p(.|\n|\r)*&quot;, [M, Lev]) || {M, {Lev, _}} &lt;- LogLevel],
<a name="919"/>  919:     Regexp = lists:flatten(RegList),
<a name="920"/>  920:     Len = length(R),
<a name="get_loglevel-last_expr"/><a name="921"/>  921: <b>    {match, [{0, Len}]} = re:run</b>(R, Regexp, [{capture, first}]).
<a name="922"/>  922: 
<a name="remove_old_messages_test-1"/><a name="923"/>  923: <b>remove_old_messages_test</b>(Config) -&gt;
<a name="remove_old_messages_test-last_expr"/><a name="924"/>  924: <b>    escalus:story</b>(Config, [{alice, 1}], fun(_) -&gt;
<a name="925"/>  925:         %% given
<a name="926"/>  926:         JidA = nick_to_jid(alice, Config),
<a name="927"/>  927:         JidB = nick_to_jid(bob, Config),
<a name="928"/>  928:         JidRecordAlice = rpc_call(jid, from_binary, [JidA]),
<a name="929"/>  929:         JidRecordBob = rpc_call(jid, from_binary, [JidB]),
<a name="930"/>  930:         Msg1 = escalus_stanza:chat_to(&lt;&lt;&quot;bob@localhost&quot;&gt;&gt;, &quot;Hi, how are you? Its old message!&quot;),
<a name="931"/>  931:         Msg2 = escalus_stanza:chat_to(&lt;&lt;&quot;bob@localhost&quot;&gt;&gt;, &quot;Hello its new message!&quot;),
<a name="932"/>  932:         OldTimestamp = fallback_timestamp(10, now()),
<a name="933"/>  933:         OfflineOld = generate_offline_message(JidRecordAlice, JidRecordBob, Msg1, OldTimestamp),
<a name="934"/>  934:         OfflineNew = generate_offline_message(JidRecordAlice, JidRecordBob, Msg2, now()),
<a name="935"/>  935:         {jid, _, _, _, LUser, LServer, _} = JidRecordBob,
<a name="936"/>  936:         rpc_call(mod_offline_backend, write_messages, [LUser, LServer, [OfflineOld, OfflineNew]]),
<a name="937"/>  937:         %% when
<a name="938"/>  938:         {_, 0} = ejabberdctl(&quot;delete_old_messages&quot;, [&quot;1&quot;], Config),
<a name="939"/>  939:         {ok, SecondList} = rpc_call(mod_offline_backend, pop_messages, [LUser, LServer]),
<a name="940"/>  940:         %% then
<a name="941"/>  941:         1 = length(SecondList)
<a name="942"/>  942:     end).
<a name="943"/>  943: 
<a name="remove_expired_messages_test-1"/><a name="944"/>  944: <b>remove_expired_messages_test</b>(Config) -&gt;
<a name="remove_expired_messages_test-last_expr"/><a name="945"/>  945: <b>    escalus:story</b>(Config, [{mike, 1}], fun(_) -&gt;
<a name="946"/>  946:         %% given
<a name="947"/>  947:         JidA = nick_to_jid(mike, Config),
<a name="948"/>  948:         JidB = nick_to_jid(kate, Config),
<a name="949"/>  949:         JidRecordMike = rpc_call(jid, from_binary, [JidA]),
<a name="950"/>  950:         JidRecordKate = rpc_call(jid, from_binary, [JidB]),
<a name="951"/>  951:         Msg1 = escalus_stanza:chat_to(&lt;&lt;&quot;kate@localhost&quot;&gt;&gt;, &quot;Rolling stones&quot;),
<a name="952"/>  952:         Msg2 = escalus_stanza:chat_to(&lt;&lt;&quot;kate@localhost&quot;&gt;&gt;, &quot;Arctic monkeys!&quot;),
<a name="953"/>  953:         Msg3 = escalus_stanza:chat_to(&lt;&lt;&quot;kate@localhost&quot;&gt;&gt;, &quot;More wine...&quot;),
<a name="954"/>  954:         Msg4 = escalus_stanza:chat_to(&lt;&lt;&quot;kate@localhost&quot;&gt;&gt;, &quot;kings of leon&quot;),
<a name="955"/>  955:         OldTimestamp = fallback_timestamp(10, now()),
<a name="956"/>  956:         ExpirationTime = fallback_timestamp(2, now()),
<a name="957"/>  957:         ExpirationTimeFuture= fallback_timestamp(-5, now()),
<a name="958"/>  958:         OfflineOld = generate_offline_expired_message(JidRecordMike, JidRecordKate, Msg1, OldTimestamp, ExpirationTime),
<a name="959"/>  959:         OfflineNow = generate_offline_expired_message(JidRecordMike, JidRecordKate, Msg2, now(), ExpirationTime),
<a name="960"/>  960:         OfflineFuture = generate_offline_expired_message(JidRecordMike, JidRecordKate, Msg3, now(), ExpirationTimeFuture),
<a name="961"/>  961:         OfflineFuture2 = generate_offline_expired_message(JidRecordMike, JidRecordKate, Msg4, OldTimestamp, ExpirationTimeFuture),
<a name="962"/>  962:         {jid, _, _, _, LUser, LServer, _} = JidRecordKate,
<a name="963"/>  963:         rpc_call(mod_offline_backend, write_messages, [LUser, LServer, [OfflineOld, OfflineNow, OfflineFuture, OfflineFuture2]]),
<a name="964"/>  964:         %% when
<a name="965"/>  965:         {_, 0} = ejabberdctl(&quot;delete_expired_messages&quot;, [], Config),
<a name="966"/>  966:         {ok, SecondList} = rpc_call(mod_offline_backend, pop_messages, [LUser, LServer]),
<a name="967"/>  967:         %% then
<a name="968"/>  968:         2 = length(SecondList)
<a name="969"/>  969:     end).
<a name="970"/>  970: 
<a name="971"/>  971: <i>%%-----------------------------------------------------------------</i>
<a name="972"/>  972: <i>%% Helpers</i>
<a name="973"/>  973: <i>%%-----------------------------------------------------------------</i>
<a name="974"/>  974: 
<a name="975"/>  975: 
<a name="nick_to_jid-2"/><a name="976"/>  976: <b>nick_to_jid</b>(UserName, Config) when is_atom(UserName) -&gt;
<a name="977"/>  977:     UserSpec = escalus_users:get_userspec(Config, UserName),
<a name="nick_to_jid-last_expr"/><a name="978"/>  978: <b>    escalus_utils:jid_to_lower</b>(escalus_users:get_jid(Config, UserSpec)).
<a name="979"/>  979: 
<a name="generate_offline_message-4"/><a name="980"/>  980: <b>generate_offline_message</b>(From, To, Msg, TimeStamp) -&gt;
<a name="981"/>  981:     {jid, _, _, _, LUser, LServer, _} = To,
<a name="generate_offline_message-last_expr"/><a name="982"/>  982:     #offline_msg{us = {LUser, LServer}, timestamp = TimeStamp, expire = never, from = From, to = To, packet = Msg}.
<a name="983"/>  983: 
<a name="generate_offline_expired_message-5"/><a name="984"/>  984: <b>generate_offline_expired_message</b>(From, To, Msg, TimeStamp, ExpirationTime) -&gt;
<a name="985"/>  985:     {jid, _, _, _, LUser, LServer, _} = To,
<a name="generate_offline_expired_message-last_expr"/><a name="986"/>  986:     #offline_msg{us = {LUser, LServer}, timestamp = TimeStamp, expire = ExpirationTime, from = From, to = To, packet = Msg}.
<a name="987"/>  987: 
<a name="988"/>  988: 
<a name="fallback_timestamp-2"/><a name="989"/>  989: <b>fallback_timestamp</b>(Days, {MegaSecs, Secs, _MicroSecs}) -&gt;
<a name="990"/>  990:     S = MegaSecs * 1000000 + Secs - 60 * 60 * 24 * Days,
<a name="991"/>  991:     MegaSecs1 = S div 1000000,
<a name="992"/>  992:     Secs1 = S rem 1000000,
<a name="fallback_timestamp-last_expr"/><a name="993"/>  993:     {MegaSecs1, Secs1, 0}.
<a name="994"/>  994: 
<a name="995"/>  995: 
<a name="start_mod_admin_extra-0"/><a name="996"/>  996: <b>start_mod_admin_extra</b>() -&gt;
<a name="997"/>  997:     Domain = ct:get_config(ejabberd_domain),
<a name="start_mod_admin_extra-last_expr"/><a name="998"/>  998: <b>    ok = dynamic_modules:restart</b>(Domain, mod_admin_extra, []).
<a name="999"/>  999: 
<a name="get_user_data-2"/><a name="1000"/> 1000: <b>get_user_data</b>(User, Config) when is_atom(User) -&gt;
<a name="1001"/> 1001:     get_user_data(escalus_users:get_options(Config, User, &lt;&lt;&quot;newres&quot;&gt;&gt;), Config);
<a name="1002"/> 1002: <b>get_user_data</b>(User, _Config) -&gt;
<a name="1003"/> 1003:     {_, Password} = lists:keyfind(password, 1, User),
<a name="1004"/> 1004:     {_, Username} = lists:keyfind(username, 1, User),
<a name="1005"/> 1005:     {_, Domain} = lists:keyfind(server, 1, User),
<a name="get_user_data-last_expr"/><a name="1006"/> 1006:     {Username, Domain, Password}.
<a name="1007"/> 1007: 
<a name="get_md5-1"/><a name="1008"/> 1008: <b>get_md5</b>(AccountPass) -&gt;
<a name="get_md5-last_expr"/><a name="1009"/> 1009: <b>    lists:flatten</b>([io_lib:format(&quot;~.16B&quot;, [X])
<a name="1010"/> 1010:                    || X &lt;- binary_to_list(crypto:hash(md5, AccountPass))]).
<a name="get_sha-1"/><a name="1011"/> 1011: <b>get_sha</b>(AccountPass) -&gt;
<a name="get_sha-last_expr"/><a name="1012"/> 1012: <b>    lists:flatten</b>([io_lib:format(&quot;~.16B&quot;, [X])
<a name="1013"/> 1013:                    || X &lt;- binary_to_list(crypto:hash(sha, AccountPass))]).
<a name="1014"/> 1014: 
<a name="set_last-3"/><a name="1015"/> 1015: <b>set_last</b>(User, Domain, TStamp) -&gt;
<a name="1016"/> 1016:     Mod = escalus_ejabberd:rpc(mod_admin_extra_last, get_lastactivity_module, [Domain]),
<a name="1017"/> 1017:     Fun = escalus_ejabberd:rpc(mod_admin_extra_last, get_lastactivity_fun, [Domain]),
<a name="set_last-last_expr"/><a name="1018"/> 1018: <b>    escalus_ejabberd:rpc</b>(Mod, Fun, [escalus_utils:jid_to_lower(User), Domain, TStamp, &lt;&lt;&gt;&gt;]).
<a name="1019"/> 1019: 
<a name="delete_users-1"/><a name="1020"/> 1020: <b>delete_users</b>(Config) -&gt;
<a name="1021"/> 1021:     Users = escalus_users:get_users([alice, bob, kate, mike]),
<a name="delete_users-last_expr"/><a name="1022"/> 1022: <b>    lists:foreach</b>(fun({_User, UserSpec}) -&gt;
<a name="1023"/> 1023:                 {Username, Domain, _Pass} = get_user_data(UserSpec, Config),
<a name="1024"/> 1024:                 escalus_ejabberd:rpc(ejabberd_auth, remove_user, [Username, Domain])
<a name="1025"/> 1025:         end, Users).
<a name="1026"/> 1026: 
<a name="1027"/> 1027: <i>%%-----------------------------------------------------------------</i>
<a name="1028"/> 1028: <i>%% Predicates</i>
<a name="1029"/> 1029: <i>%%-----------------------------------------------------------------</i>
<a name="1030"/> 1030: 
<a name="match_user_status-2"/><a name="1031"/> 1031: <b>match_user_status</b>(Users, StatusTxt) -&gt;
<a name="1032"/> 1032:     Statuses = string:tokens(StatusTxt, &quot;\n&quot;),
<a name="1033"/> 1033: 
<a name="1034"/> 1034:     true = (length(Users) == length(Statuses)),
<a name="match_user_status-last_expr"/><a name="1035"/> 1035: <b>    match_user_status2</b>(Users, Statuses).
<a name="1036"/> 1036: 
<a name="match_user_status2-2"/><a name="1037"/> 1037: <b>match_user_status2</b>([], _) -&gt;
<a name="1038"/> 1038:     true;
<a name="1039"/> 1039: <b>match_user_status2</b>([User | UserR], Statuses) -&gt;
<a name="1040"/> 1040:     Username = binary_to_list(escalus_client:username(User)),
<a name="1041"/> 1041:     Domain = binary_to_list(escalus_client:server(User)),
<a name="1042"/> 1042:     Resource = binary_to_list(escalus_client:resource(User)),
<a name="1043"/> 1043: 
<a name="1044"/> 1044:     true = lists:any(fun(Status) -&gt;
<a name="1045"/> 1045:                 [Username, Domain, Resource]
<a name="1046"/> 1046:                 =:=
<a name="1047"/> 1047:                 lists:sublist(string:tokens(Status, &quot;\t&quot;), 1, 3)
<a name="1048"/> 1048:         end, Statuses),
<a name="match_user_status2-last_expr"/><a name="1049"/> 1049: <b>    match_user_status2</b>(UserR, Statuses).
<a name="1050"/> 1050: 
<a name="match_user_info-2"/><a name="1051"/> 1051: <b>match_user_info</b>(Users, UsersTxt) -&gt;
<a name="1052"/> 1052:     UsersInfo = string:tokens(UsersTxt, &quot;\n&quot;),
<a name="1053"/> 1053: 
<a name="1054"/> 1054:     true = (length(Users) == length(UsersInfo)),
<a name="match_user_info-last_expr"/><a name="1055"/> 1055: <b>    match_user_info2</b>(Users, UsersInfo).
<a name="1056"/> 1056: 
<a name="match_user_info2-2"/><a name="1057"/> 1057: <b>match_user_info2</b>([], _) -&gt;
<a name="1058"/> 1058:     true;
<a name="1059"/> 1059: <b>match_user_info2</b>([User | UserR], UsersInfo) -&gt;
<a name="1060"/> 1060:     Username = binary_to_list(escalus_client:username(User)),
<a name="1061"/> 1061:     Domain = binary_to_list(escalus_client:server(User)),
<a name="1062"/> 1062:     Resource = binary_to_list(escalus_client:resource(User)),
<a name="1063"/> 1063:     FullJID = Username ++ &quot;@&quot; ++ Domain ++ &quot;/&quot; ++ Resource,
<a name="1064"/> 1064: 
<a name="1065"/> 1065:     true = lists:any(fun(UserInfo) -&gt;
<a name="1066"/> 1066:                 string:str(UserInfo, string:to_lower(FullJID)) =:= 1
<a name="1067"/> 1067:         end, UsersInfo),
<a name="match_user_info2-last_expr"/><a name="1068"/> 1068: <b>    match_user_info2</b>(UserR, UsersInfo).
<a name="1069"/> 1069: 
<a name="match_roster-2"/><a name="1070"/> 1070: <b>match_roster</b>(ItemsValid, Items) -&gt;
<a name="1071"/> 1071:     ItemsTokens = [ string:tokens(ItemToken, &quot;\t&quot;) || ItemToken &lt;- string:tokens(Items, &quot;\n&quot;) ],
<a name="1072"/> 1072: 
<a name="1073"/> 1073:     true = (length(ItemsValid) == length(ItemsTokens)),
<a name="match_roster-last_expr"/><a name="1074"/> 1074: <b>    true = lists:all</b>(fun({Username, Domain, Nick, Group, Sub}) -&gt;
<a name="1075"/> 1075:                     JID = escalus_utils:jid_to_lower(&lt;&lt;Username/binary, &quot;@&quot;, Domain/binary &gt;&gt;),
<a name="1076"/> 1076:                     lists:any(fun
<a name="1077"/> 1077:                                 ([RosterJID, Nick, Sub, &quot;none&quot;, Group]) -&gt;
<a name="1078"/> 1078:                                     JID =:= escalus_utils:jid_to_lower(list_to_binary(RosterJID));
<a name="1079"/> 1079:                                 (_) -&gt;
<a name="1080"/> 1080:                                     false
<a name="1081"/> 1081:                               end, ItemsTokens)
<a name="1082"/> 1082:             end, ItemsValid).
<a name="1083"/> 1083: 
<a name="string_to_binary-1"/><a name="1084"/> 1084: <b>string_to_binary</b>(List) -&gt;
<a name="string_to_binary-last_expr"/><a name="1085"/> 1085: <b>    case erlang:system_info</b>(otp_release) of
<a name="1086"/> 1086:         [$R|_] -&gt;
<a name="1087"/> 1087:             list_to_binary(List);
<a name="1088"/> 1088:         _ -&gt;
<a name="1089"/> 1089:             unicode:characters_to_binary(List)
<a name="1090"/> 1090:     end.
</pre>
</body>
</html>
