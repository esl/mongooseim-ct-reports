<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>/home/travis/build/esl/MongooseIM/test/ejabberd_tests/tests/ejabberdctl_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%==============================================================================</i>
<a name="2"/>    2: <i>%% Copyright 2013 Erlang Solutions Ltd.</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="5"/>    5: <i>%% you may not use this file except in compliance with the License.</i>
<a name="6"/>    6: <i>%% You may obtain a copy of the License at</i>
<a name="7"/>    7: <i>%%</i>
<a name="8"/>    8: <i>%% http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="11"/>   11: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="12"/>   12: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="13"/>   13: <i>%% See the License for the specific language governing permissions and</i>
<a name="14"/>   14: <i>%% limitations under the License.</i>
<a name="15"/>   15: <i>%%==============================================================================</i>
<a name="16"/>   16: <b>-module</b>(ejabberdctl_SUITE).
<a name="17"/>   17: <b>-compile</b>(export_all).
<a name="18"/>   18: 
<a name="19"/>   19: <b>-include_lib</b>(&quot;escalus/include/escalus.hrl&quot;).
<a name="20"/>   20: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="21"/>   21: <b>-include_lib</b>(&quot;exml/include/exml.hrl&quot;).
<a name="22"/>   22: <b>-include_lib</b>(&quot;exml/include/exml.hrl&quot;).
<a name="23"/>   23: 
<a name="24"/>   24: <b>-import</b>(ejabberdctl_helper, [ejabberdctl/3, rpc_call/3]).
<a name="25"/>   25: <b>-import</b>(mongoose_helper, [auth_modules/0]).
<a name="26"/>   26: 
<a name="27"/>   27: <b>-define</b>(SINGLE_QUOTE_CHAR, $\').
<a name="28"/>   28: <b>-define</b>(DOUBLE_QUOTE_CHAR, $\&quot;).
<a name="29"/>   29: 
<a name="30"/>   30: <b>-record</b>(offline_msg, {us, timestamp, expire, from, to, packet}).
<a name="31"/>   31: 
<a name="32"/>   32: <i>%%--------------------------------------------------------------------</i>
<a name="33"/>   33: <i>%% Suite configuration</i>
<a name="34"/>   34: <i>%%--------------------------------------------------------------------</i>
<a name="35"/>   35: 
<a name="all-0"/><a name="36"/>   36: <b>all</b>() -&gt;
<a name="37"/>   37:     [{group, accounts},
<a name="38"/>   38:      {group, sessions},
<a name="39"/>   39:      {group, vcard},
<a name="40"/>   40:      {group, roster},
<a name="41"/>   41:      {group, roster_advanced},
<a name="42"/>   42:      {group, last},
<a name="43"/>   43:      {group, private},
<a name="44"/>   44:      {group, stanza},
<a name="45"/>   45:      {group, stats},
<a name="46"/>   46:      {group, basic}].
<a name="47"/>   47: 
<a name="groups-0"/><a name="48"/>   48: <b>groups</b>() -&gt;
<a name="49"/>   49:      [{accounts, [sequence], accounts()},
<a name="50"/>   50:       {sessions, [sequence], sessions()},
<a name="51"/>   51:       {vcard, [sequence], vcard()},
<a name="52"/>   52:       {roster, [sequence], roster()},
<a name="53"/>   53:       {last, [sequence], last()},
<a name="54"/>   54:       {private, [sequence], private()},
<a name="55"/>   55:       {stanza, [sequence], stanza()},
<a name="56"/>   56:       {roster_advanced, [sequence], roster_advanced()},
<a name="57"/>   57:       {basic, [sequence], basic()},
<a name="58"/>   58:       {stats, [sequence], stats()}].
<a name="59"/>   59: 
<a name="basic-0"/><a name="60"/>   60: <b>basic</b>() -&gt;
<a name="61"/>   61:     [simple_register, simple_unregister, register_twice,
<a name="62"/>   62:         backup_restore_mnesia,
<a name="63"/>   63:         restore_mnesia_wrong,
<a name="64"/>   64:         dump_and_load,
<a name="65"/>   65:         load_mnesia_wrong,
<a name="66"/>   66:         dump_table,
<a name="67"/>   67:         get_loglevel,
<a name="68"/>   68:         remove_old_messages_test,
<a name="69"/>   69:         remove_expired_messages_test
<a name="70"/>   70:     ].
<a name="71"/>   71: 
<a name="accounts-0"/><a name="72"/>   72: <b>accounts</b>() -&gt; [change_password, check_password_hash, check_password,
<a name="73"/>   73:                check_account, ban_account, num_active_users, delete_old_users,
<a name="74"/>   74:                delete_old_users_vhost].
<a name="75"/>   75: 
<a name="sessions-0"/><a name="76"/>   76: <b>sessions</b>() -&gt; [num_resources_num, kick_session, status,
<a name="77"/>   77:                sessions_info, set_presence].
<a name="78"/>   78: 
<a name="vcard-0"/><a name="79"/>   79: <b>vcard</b>() -&gt; [vcard_rw, vcard2_rw, vcard2_multi_rw].
<a name="80"/>   80: 
<a name="roster-0"/><a name="81"/>   81: <b>roster</b>() -&gt; [rosteritem_rw, presence_after_add_rosteritem,
<a name="82"/>   82:              push_roster,
<a name="83"/>   83:              push_roster_all,
<a name="84"/>   84:              push_roster_alltoall].
<a name="85"/>   85: 
<a name="roster_advanced-0"/><a name="86"/>   86: <b>roster_advanced</b>() -&gt;[process_rosteritems_list_simple,
<a name="87"/>   87:                           process_rosteritems_list_nomatch,
<a name="88"/>   88:                           process_rosteritems_list_advanced1,
<a name="89"/>   89:                           process_rosteritems_list_advanced2,
<a name="90"/>   90:                           process_rosteritems_delete_advanced,
<a name="91"/>   91:                           process_rosteritems_delete_advanced2].
<a name="92"/>   92: 
<a name="last-0"/><a name="93"/>   93: <b>last</b>() -&gt; [set_last].
<a name="94"/>   94: 
<a name="private-0"/><a name="95"/>   95: <b>private</b>() -&gt; [private_rw].
<a name="96"/>   96: 
<a name="stanza-0"/><a name="97"/>   97: <b>stanza</b>() -&gt; [send_message, send_message_wrong_jid, send_stanza, send_stanzac2s_wrong].
<a name="98"/>   98: 
<a name="stats-0"/><a name="99"/>   99: <b>stats</b>() -&gt; [stats_global, stats_host].
<a name="100"/>  100: 
<a name="suite-0"/><a name="101"/>  101: <b>suite</b>() -&gt;
<a name="102"/>  102:     escalus:suite().
<a name="103"/>  103: 
<a name="init_per_suite-1"/><a name="104"/>  104: <b>init_per_suite</b>(Config) -&gt;
<a name="105"/>  105:     {ok, EjdWD} = escalus_ejabberd:rpc(file, get_cwd, []),
<a name="106"/>  106:     Cwd0 = escalus_config:get_config(data_dir, Config),
<a name="107"/>  107:     CwdTokens = string:tokens(Cwd0, &quot;/&quot;),
<a name="108"/>  108:     Cwd =  [$/ | string:join(lists:sublist(CwdTokens, 1, length(CwdTokens)-2), &quot;/&quot;)],
<a name="109"/>  109:     TemplatePath = Cwd ++ &quot;/roster.template&quot;,
<a name="110"/>  110:     start_mod_admin_extra(),
<a name="111"/>  111:     CtlPath = case filelib:is_file(EjdWD ++ &quot;/bin/ejabberdctl&quot;) of
<a name="112"/>  112:                   true -&gt; EjdWD ++ &quot;/bin/ejabberdctl&quot;;
<a name="113"/>  113:                   false -&gt; EjdWD ++ &quot;/bin/mongooseimctl&quot;
<a name="114"/>  114:               end,
<a name="115"/>  115: 
<a name="116"/>  116:     AuthMods = auth_modules(),
<a name="117"/>  117: 
<a name="118"/>  118:     NewConfig = escalus:init_per_suite([{ctl_path, CtlPath},
<a name="119"/>  119:                                         {ctl_auth_mods, AuthMods},
<a name="120"/>  120:                                         {roster_template, TemplatePath} | Config]),
<a name="121"/>  121:     escalus:create_users(NewConfig, escalus:get_users([alice, mike, bob, kate])).
<a name="122"/>  122: 
<a name="end_per_suite-1"/><a name="123"/>  123: <b>end_per_suite</b>(Config) -&gt;
<a name="124"/>  124:     Config1 = lists:keydelete(ctl_auth_mods, 1, Config),
<a name="125"/>  125:     delete_users(Config1),
<a name="126"/>  126:     escalus:end_per_suite(Config1).
<a name="127"/>  127: 
<a name="init_per_group-2"/><a name="128"/>  128: <b>init_per_group</b>(vcard, Config) -&gt;
<a name="129"/>  129:     case escalus_ejabberd:rpc(gen_mod,get_module_opt,
<a name="130"/>  130:                               [ct:get_config(ejabberd_domain),
<a name="131"/>  131:                                mod_vcard, backend, mnesia]) of
<a name="132"/>  132:         ldap -&gt;
<a name="133"/>  133:             {skip, vcard_set_not_supported_with_ldap};
<a name="134"/>  134:         _ -&gt;
<a name="135"/>  135:             Config
<a name="136"/>  136:     end;
<a name="137"/>  137: 
<a name="138"/>  138: <b>init_per_group</b>(roster_advanced, Config) -&gt;
<a name="139"/>  139:     case escalus_ejabberd:rpc(gen_mod,get_module_opt,[ct:get_config(ejabberd_domain), mod_roster, backend, mnesia]) of
<a name="140"/>  140:         mnesia -&gt;
<a name="141"/>  141:             Config;
<a name="142"/>  142:         _ -&gt;
<a name="143"/>  143:             {skip, command_process_rosteritems_supports_only_mnesia}
<a name="144"/>  144:     end;
<a name="145"/>  145: 
<a name="146"/>  146: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="147"/>  147:     Config.
<a name="148"/>  148: 
<a name="end_per_group-2"/><a name="149"/>  149: <b>end_per_group</b>(Rosters, Config) when (Rosters == roster) or (Rosters == roster_advanced) -&gt;
<a name="150"/>  150:     TemplatePath = escalus_config:get_config(roster_template, Config),
<a name="151"/>  151:     RegUsers = [atom_to_list(U) || {U, _} &lt;- escalus_config:get_config(escalus_users, Config)],
<a name="152"/>  152:     {ok, [Roster]} = file:consult(TemplatePath),
<a name="153"/>  153:     io:format(&quot;Roster is ~p~n and registred is ~p&quot;,[Roster, RegUsers]),
<a name="154"/>  154:     C = fun({U, S, _, _}) -&gt;
<a name="155"/>  155:         case lists:member(U, RegUsers) of
<a name="156"/>  156:             true -&gt;
<a name="157"/>  157:                 SB = string_to_binary(S),
<a name="158"/>  158:                 UB = string_to_binary(U),
<a name="159"/>  159:                 escalus_ejabberd:rpc(ejabberd_hooks, run, [remove_user, SB, [UB, SB]]);
<a name="160"/>  160:             _ -&gt;
<a name="161"/>  161:                ok
<a name="162"/>  162:         end
<a name="163"/>  163:     end,
<a name="164"/>  164:     lists:foreach(C, Roster),
<a name="165"/>  165:     Config;
<a name="166"/>  166: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="167"/>  167:     Config.
<a name="168"/>  168: 
<a name="init_per_testcase-2"/><a name="169"/>  169: <b>init_per_testcase</b>(CaseName, Config)
<a name="170"/>  170:   % these cases are incompatible with domainless odbc schema
<a name="171"/>  171:   when CaseName == delete_old_users_vhost
<a name="172"/>  172:        orelse CaseName == stats_global
<a name="173"/>  173:        orelse CaseName == stats_host -&gt;
<a name="174"/>  174:     {_, AuthMods} = lists:keyfind(ctl_auth_mods, 1, Config),
<a name="175"/>  175:     case lists:member(ejabberd_auth_odbc, AuthMods) orelse
<a name="176"/>  176:          lists:member(ejabberd_auth_ldap, AuthMods) of
<a name="177"/>  177:         true -&gt; {skip, vhost_odbc_incompatible};
<a name="178"/>  178:         false -&gt; escalus:init_per_testcase(CaseName, Config)
<a name="179"/>  179:     end;
<a name="180"/>  180: <b>init_per_testcase</b>(CaseName, Config)
<a name="181"/>  181:     when CaseName == check_password_hash;
<a name="182"/>  182:          CaseName == delete_old_users -&gt;
<a name="183"/>  183:     {_, AuthMods} = lists:keyfind(ctl_auth_mods, 1, Config),
<a name="184"/>  184:     case lists:member(ejabberd_auth_ldap, AuthMods) of
<a name="185"/>  185:         true -&gt; {skip, not_fully_supported_with_ldap};
<a name="186"/>  186:         false -&gt; escalus:init_per_testcase(CaseName, Config)
<a name="187"/>  187:     end;
<a name="188"/>  188: <b>init_per_testcase</b>(CaseName, Config) -&gt;
<a name="189"/>  189:     escalus:init_per_testcase(CaseName, Config).
<a name="190"/>  190: 
<a name="end_per_testcase-2"/><a name="191"/>  191: <b>end_per_testcase</b>(delete_old_users, Config) -&gt;
<a name="192"/>  192:     Users = escalus_users:get_users([alice, bob, kate, mike]),
<a name="193"/>  193:     lists:foreach(fun({_User, UserSpec}) -&gt;
<a name="194"/>  194:                 {Username, Domain, Pass} = get_user_data(UserSpec, Config),
<a name="195"/>  195:                 escalus_ejabberd:rpc(ejabberd_auth, try_register, [Username, Domain, Pass])
<a name="196"/>  196:         end, Users),
<a name="197"/>  197:     escalus_cleaner:clean(Config),
<a name="198"/>  198:     escalus:end_per_testcase(delete_old_users, Config);
<a name="199"/>  199: <b>end_per_testcase</b>(CaseName, Config) -&gt;
<a name="200"/>  200:     escalus_cleaner:clean(Config),
<a name="201"/>  201:     escalus:end_per_testcase(CaseName, Config).
<a name="202"/>  202: 
<a name="203"/>  203: <i>%%--------------------------------------------------------------------</i>
<a name="204"/>  204: <i>%% mod_admin_extra_accounts tests</i>
<a name="205"/>  205: <i>%%--------------------------------------------------------------------</i>
<a name="206"/>  206: 
<a name="change_password-1"/><a name="207"/>  207: <b>change_password</b>(Config) -&gt;
<a name="208"/>  208:     {User, Domain, OldPassword} = get_user_data(alice, Config),
<a name="209"/>  209:     ejabberdctl(&quot;change_password&quot;, [User, Domain, &lt;&lt;OldPassword/binary, $2&gt;&gt;], Config),
<a name="210"/>  210:     {error, {connection_step_failed, _, _}} = escalus_client:start_for(Config, alice, &lt;&lt;&quot;newres&quot;&gt;&gt;),
<a name="211"/>  211:     ejabberdctl(&quot;change_password&quot;, [User, Domain, OldPassword], Config),
<a name="212"/>  212:     {ok, _Alice2} = escalus_client:start_for(Config, alice, &lt;&lt;&quot;newres2&quot;&gt;&gt;).
<a name="213"/>  213: 
<a name="check_password_hash-1"/><a name="214"/>  214: <b>check_password_hash</b>(Config) -&gt;
<a name="215"/>  215:     {User, Domain, Pass} = get_user_data(alice, Config),
<a name="216"/>  216:     MD5Hash = get_md5(Pass),
<a name="217"/>  217:     MD5HashBad = get_md5(&lt;&lt;Pass/binary, &quot;bad&quot;&gt;&gt;),
<a name="218"/>  218:     SHAHash = get_sha(Pass),
<a name="219"/>  219: 
<a name="220"/>  220:     {_, 0} = ejabberdctl(&quot;check_password_hash&quot;, [User, Domain, MD5Hash, &quot;md5&quot;], Config),
<a name="221"/>  221:     {_, ErrCode} = ejabberdctl(&quot;check_password_hash&quot;, [User, Domain, MD5HashBad, &quot;md5&quot;], Config),
<a name="222"/>  222:     true = (ErrCode =/= 0), %% Must return code other than 0
<a name="223"/>  223:     {_, 0} = ejabberdctl(&quot;check_password_hash&quot;, [User, Domain, SHAHash, &quot;sha&quot;], Config).
<a name="224"/>  224: 
<a name="check_password-1"/><a name="225"/>  225: <b>check_password</b>(Config) -&gt;
<a name="226"/>  226:     {User, Domain, Pass} = get_user_data(alice, Config),
<a name="227"/>  227: 
<a name="228"/>  228:     {_, 0} = ejabberdctl(&quot;check_password&quot;, [User, Domain, Pass], Config),
<a name="229"/>  229:     {_, ErrCode} = ejabberdctl(&quot;check_password&quot;, [User, Domain, &lt;&lt;Pass/binary, &quot;Bad&quot;&gt;&gt;], Config),
<a name="230"/>  230:     true = (ErrCode =/= 0). %% Must return code other than 0
<a name="231"/>  231: 
<a name="check_account-1"/><a name="232"/>  232: <b>check_account</b>(Config) -&gt;
<a name="233"/>  233:     {User, Domain, _Pass} = get_user_data(alice, Config),
<a name="234"/>  234: 
<a name="235"/>  235:     {_, 0} = ejabberdctl(&quot;check_account&quot;, [User, Domain], Config),
<a name="236"/>  236:     {_, ErrCode} = ejabberdctl(&quot;check_account&quot;, [&lt;&lt;User/binary, &quot;Bad&quot;&gt;&gt;, Domain], Config),
<a name="237"/>  237:     true = (ErrCode =/= 0). %% Must return code other than 0
<a name="238"/>  238: 
<a name="ban_account-1"/><a name="239"/>  239: <b>ban_account</b>(Config) -&gt;
<a name="240"/>  240:     {User, Domain, Pass} = get_user_data(mike, Config),
<a name="241"/>  241: 
<a name="242"/>  242:     {ok, Mike} = escalus_client:start_for(Config, mike, &lt;&lt;&quot;newres&quot;&gt;&gt;),
<a name="243"/>  243:     {_, 0} = ejabberdctl(&quot;ban_account&quot;, [User, Domain, &quot;SomeReason&quot;], Config),
<a name="244"/>  244:     escalus:assert(is_stream_error, [&lt;&lt;&quot;conflict&quot;&gt;&gt;, &lt;&lt;&quot;SomeReason&quot;&gt;&gt;], escalus:wait_for_stanza(Mike)),
<a name="245"/>  245:     {error, {connection_step_failed, _, _}} = escalus_client:start_for(Config, mike, &lt;&lt;&quot;newres2&quot;&gt;&gt;),
<a name="246"/>  246:     ejabberdctl(&quot;change_password&quot;, [User, Domain, Pass], Config).
<a name="247"/>  247: 
<a name="num_active_users-1"/><a name="248"/>  248: <b>num_active_users</b>(Config) -&gt;
<a name="249"/>  249:     {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="250"/>  250:     {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="251"/>  251: 
<a name="252"/>  252:     {Mega, Secs, _} = erlang:now(),
<a name="253"/>  253:     Now = Mega*1000000+Secs,
<a name="254"/>  254:     set_last(AliceName, Domain, Now),
<a name="255"/>  255:     set_last(MikeName, Domain, Now - 864000), %% Now - 10 days
<a name="256"/>  256:     {&quot;1\n&quot;, _} = ejabberdctl(&quot;num_active_users&quot;, [Domain, &quot;5&quot;], Config).
<a name="257"/>  257: 
<a name="delete_old_users-1"/><a name="258"/>  258: <b>delete_old_users</b>(Config) -&gt;
<a name="259"/>  259:     {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="260"/>  260:     {BobName, Domain, _} = get_user_data(bob, Config),
<a name="261"/>  261:     {KateName, Domain, _} = get_user_data(kate, Config),
<a name="262"/>  262:     {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="263"/>  263: 
<a name="264"/>  264:     {Mega, Secs, _} = erlang:now(),
<a name="265"/>  265:     Now = Mega*1000000+Secs,
<a name="266"/>  266:     set_last(AliceName, Domain, Now),
<a name="267"/>  267:     set_last(BobName, Domain, Now),
<a name="268"/>  268:     set_last(MikeName, Domain, Now),
<a name="269"/>  269: 
<a name="270"/>  270:     {_, 0} = ejabberdctl(&quot;delete_old_users&quot;, [&quot;10&quot;], Config),
<a name="271"/>  271:     {_, 0} = ejabberdctl(&quot;check_account&quot;, [AliceName, Domain], Config),
<a name="272"/>  272:     {_, ErrCode} = ejabberdctl(&quot;check_account&quot;, [KateName, Domain], Config),
<a name="273"/>  273:     true = (ErrCode =/= 0). %% Must return code other than 0
<a name="274"/>  274: 
<a name="delete_old_users_vhost-1"/><a name="275"/>  275: <b>delete_old_users_vhost</b>(Config) -&gt;
<a name="276"/>  276:     {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="277"/>  277:     {KateName, Domain, KatePass} = get_user_data(kate, Config),
<a name="278"/>  278:     SecDomain = escalus_config:get_config(ejabberd_secondary_domain, Config),
<a name="279"/>  279: 
<a name="280"/>  280:     {Mega, Secs, _} = erlang:now(),
<a name="281"/>  281:     Now = Mega*1000000+Secs,
<a name="282"/>  282:     set_last(AliceName, Domain, Now-86400*30),
<a name="283"/>  283: 
<a name="284"/>  284:     {_, 0} = ejabberdctl(&quot;register&quot;, [KateName, SecDomain, KatePass], Config),
<a name="285"/>  285:     {_, 0} = ejabberdctl(&quot;check_account&quot;, [KateName, SecDomain], Config),
<a name="286"/>  286:     {_, 0} = ejabberdctl(&quot;delete_old_users_vhost&quot;, [SecDomain, &quot;10&quot;], Config),
<a name="287"/>  287:     {_, 0} = ejabberdctl(&quot;check_account&quot;, [AliceName, Domain], Config),
<a name="288"/>  288:     {_, ErrCode} = ejabberdctl(&quot;check_account&quot;, [KateName, SecDomain], Config),
<a name="289"/>  289:     true = (ErrCode =/= 0). %% Must return code other than 0
<a name="290"/>  290: 
<a name="291"/>  291: <i>%%--------------------------------------------------------------------</i>
<a name="292"/>  292: <i>%% mod_admin_extra_accounts tests</i>
<a name="293"/>  293: <i>%%--------------------------------------------------------------------</i>
<a name="294"/>  294: 
<a name="295"/>  295: <i>%% Checks both num_resources and resource_num</i>
<a name="num_resources_num-1"/><a name="296"/>  296: <b>num_resources_num</b>(Config) -&gt;
<a name="297"/>  297:     escalus:story(Config, [{alice, 3}, {bob, 1}], fun(_, Alice2, _, _) -&gt;
<a name="298"/>  298:                 {Username, Domain, _} = get_user_data(alice, Config),
<a name="299"/>  299:                 ResName = binary_to_list(escalus_client:resource(Alice2)) ++ &quot;\n&quot;,
<a name="300"/>  300: 
<a name="301"/>  301:                 {&quot;3\n&quot;, _} = ejabberdctl(&quot;num_resources&quot;, [Username, Domain], Config),
<a name="302"/>  302:                 {ResName, _} = ejabberdctl(&quot;resource_num&quot;, [Username, Domain, &quot;2&quot;], Config)
<a name="303"/>  303:         end).
<a name="304"/>  304: 
<a name="kick_session-1"/><a name="305"/>  305: <b>kick_session</b>(Config) -&gt;
<a name="306"/>  306:     escalus:story(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="307"/>  307:                 Username = escalus_client:username(Alice),
<a name="308"/>  308:                 Domain = escalus_client:server(Alice),
<a name="309"/>  309:                 Resource = escalus_client:resource(Alice),
<a name="310"/>  310: 
<a name="311"/>  311:                 {_, 0} = ejabberdctl(&quot;kick_session&quot;, [Username, Domain, Resource, &quot;\&quot;Because I can!\&quot;&quot;], Config),
<a name="312"/>  312:                 Stanza = escalus:wait_for_stanza(Alice),
<a name="313"/>  313:                 escalus:assert(is_stream_error, [&lt;&lt;&quot;conflict&quot;&gt;&gt;, &lt;&lt;&quot;Because I can!&quot;&gt;&gt;], Stanza)
<a name="314"/>  314:         end).
<a name="315"/>  315: 
<a name="status-1"/><a name="316"/>  316: <b>status</b>(Config) -&gt;
<a name="317"/>  317:     escalus:story(Config, [{alice, 1}, {mike, 1}, {bob, 1}], fun(User1, User2, User3) -&gt;
<a name="318"/>  318:                 PriDomain = escalus_client:server(User1),
<a name="319"/>  319:                 SecDomain = escalus_config:get_config(ejabberd_secondary_domain, Config),
<a name="320"/>  320:                 AwayPresence = escalus_stanza:presence_show(&lt;&lt;&quot;away&quot;&gt;&gt;),
<a name="321"/>  321:                 escalus_client:send(User2, AwayPresence),
<a name="322"/>  322: 
<a name="323"/>  323:                 {&quot;2\n&quot;, _} = ejabberdctl(&quot;status_num&quot;, [&quot;available&quot;], Config),
<a name="324"/>  324: 
<a name="325"/>  325:                 {&quot;2\n&quot;, _} = ejabberdctl(&quot;status_num_host&quot;, [PriDomain, &quot;available&quot;], Config),
<a name="326"/>  326:                 {&quot;0\n&quot;, _} = ejabberdctl(&quot;status_num_host&quot;, [SecDomain, &quot;available&quot;], Config),
<a name="327"/>  327: 
<a name="328"/>  328:                 {StatusList, _} = ejabberdctl(&quot;status_list&quot;, [&quot;available&quot;], Config),
<a name="329"/>  329:                 match_user_status([User1, User3], StatusList),
<a name="330"/>  330: 
<a name="331"/>  331:                 {StatusList2, _} = ejabberdctl(&quot;status_list_host&quot;, [PriDomain, &quot;available&quot;], Config),
<a name="332"/>  332:                 match_user_status([User1, User3], StatusList2),
<a name="333"/>  333:                 {[], _} = ejabberdctl(&quot;status_list_host&quot;, [SecDomain, &quot;available&quot;], Config)
<a name="334"/>  334:         end).
<a name="335"/>  335: 
<a name="sessions_info-1"/><a name="336"/>  336: <b>sessions_info</b>(Config) -&gt;
<a name="337"/>  337:     escalus:story(Config, [{alice, 1}, {bob, 1}, {kate, 1}], fun(User1, User2, User3) -&gt;
<a name="338"/>  338:                 Username1 = escalus_client:username(User1),
<a name="339"/>  339:                 PriDomain = escalus_client:server(User1),
<a name="340"/>  340:                 SecDomain = escalus_config:get_config(ejabberd_secondary_domain, Config),
<a name="341"/>  341:                 AwayPresence = escalus_stanza:presence_show(&lt;&lt;&quot;away&quot;&gt;&gt;),
<a name="342"/>  342:                 escalus_client:send(User2, AwayPresence),
<a name="343"/>  343: 
<a name="344"/>  344:                 {UserList, _} = ejabberdctl(&quot;connected_users_info&quot;, [], Config),
<a name="345"/>  345:                 match_user_info([User1, User2, User3], UserList),
<a name="346"/>  346: 
<a name="347"/>  347:                 {UserList2, _} = ejabberdctl(&quot;connected_users_vhost&quot;, [PriDomain], Config),
<a name="348"/>  348:                 match_user_info([User1, User2, User3], UserList2),
<a name="349"/>  349:                 {[], _} = ejabberdctl(&quot;connected_users_vhost&quot;, [SecDomain], Config),
<a name="350"/>  350: 
<a name="351"/>  351:                 {UserList3, _} = ejabberdctl(&quot;user_sessions_info&quot;, [Username1, PriDomain], Config),
<a name="352"/>  352:                 match_user_info([User1], UserList3)
<a name="353"/>  353:         end).
<a name="354"/>  354: 
<a name="set_presence-1"/><a name="355"/>  355: <b>set_presence</b>(Config) -&gt;
<a name="356"/>  356:     escalus:story(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="357"/>  357:                 Username = escalus_client:username(Alice),
<a name="358"/>  358:                 Domain = escalus_client:server(Alice),
<a name="359"/>  359:                 Resource = escalus_client:resource(Alice),
<a name="360"/>  360: 
<a name="361"/>  361:                 {_, 0} = ejabberdctl(&quot;set_presence&quot;, [Username, Domain, Resource,
<a name="362"/>  362:                                                       &quot;available&quot;, &quot;away&quot;, &quot;mystatus&quot;, &quot;10&quot;], Config),
<a name="363"/>  363:                 Presence = escalus:wait_for_stanza(Alice),
<a name="364"/>  364:                 escalus:assert(is_presence_with_show, [&lt;&lt;&quot;away&quot;&gt;&gt;], Presence),
<a name="365"/>  365:                 escalus:assert(is_presence_with_status, [&lt;&lt;&quot;mystatus&quot;&gt;&gt;], Presence),
<a name="366"/>  366:                 escalus:assert(is_presence_with_priority, [&lt;&lt;&quot;10&quot;&gt;&gt;], Presence)
<a name="367"/>  367:         end).
<a name="368"/>  368: 
<a name="369"/>  369: <i>%%--------------------------------------------------------------------</i>
<a name="370"/>  370: <i>%% mod_admin_extra_vcard tests</i>
<a name="371"/>  371: <i>%%--------------------------------------------------------------------</i>
<a name="372"/>  372: 
<a name="vcard_rw-1"/><a name="373"/>  373: <b>vcard_rw</b>(Config) -&gt;
<a name="374"/>  374:     {Username, Domain, _} = get_user_data(alice, Config),
<a name="375"/>  375: 
<a name="376"/>  376:     {_, ExitCode} = ejabberdctl(&quot;get_vcard&quot;, [Username, Domain, &quot;NICKNAME&quot;], Config),
<a name="377"/>  377:     true = (ExitCode /= 0),
<a name="378"/>  378: 
<a name="379"/>  379:     {_, 0} = ejabberdctl(&quot;set_vcard&quot;, [Username, Domain, &quot;NICKNAME&quot;, &quot;SomeNickname&quot;], Config),
<a name="380"/>  380:     {&quot;SomeNickname\n&quot;, 0} = ejabberdctl(&quot;get_vcard&quot;, [Username, Domain, &quot;NICKNAME&quot;], Config).
<a name="381"/>  381: 
<a name="vcard2_rw-1"/><a name="382"/>  382: <b>vcard2_rw</b>(Config) -&gt;
<a name="383"/>  383:     {Username, Domain, _} = get_user_data(alice, Config),
<a name="384"/>  384: 
<a name="385"/>  385:     {_, ExitCode} = ejabberdctl(&quot;get_vcard2&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGNAME&quot;], Config),
<a name="386"/>  386:     true = (ExitCode /= 0),
<a name="387"/>  387: 
<a name="388"/>  388:     {_, 0} = ejabberdctl(&quot;set_vcard2&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGNAME&quot;, &quot;ESL&quot;], Config),
<a name="389"/>  389:     {&quot;ESL\n&quot;, 0} = ejabberdctl(&quot;get_vcard2&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGNAME&quot;], Config).
<a name="390"/>  390: 
<a name="vcard2_multi_rw-1"/><a name="391"/>  391: <b>vcard2_multi_rw</b>(Config) -&gt;
<a name="392"/>  392:     {Username, Domain, _} = get_user_data(alice, Config),
<a name="393"/>  393: 
<a name="394"/>  394:     {_, ExitCode} = ejabberdctl(&quot;get_vcard2_multi&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGUNIT&quot;], Config),
<a name="395"/>  395:     true = (ExitCode /= 0),
<a name="396"/>  396: 
<a name="397"/>  397:     {_, 0} = ejabberdctl(&quot;set_vcard2_multi&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGUNIT&quot;, &quot;'sales;marketing'&quot;], Config),
<a name="398"/>  398:     {OrgUnits0, 0} = ejabberdctl(&quot;get_vcard2_multi&quot;, [Username, Domain, &quot;ORG&quot;, &quot;ORGUNIT&quot;], Config),
<a name="399"/>  399:     OrgUnits = string:tokens(OrgUnits0, &quot;\n&quot;),
<a name="400"/>  400:     2 = length(OrgUnits),
<a name="401"/>  401:     true = (lists:member(&quot;sales&quot;, OrgUnits) andalso lists:member(&quot;marketing&quot;, OrgUnits)).
<a name="402"/>  402: 
<a name="403"/>  403: <i>%%--------------------------------------------------------------------</i>
<a name="404"/>  404: <i>%% mod_admin_extra_vcard tests</i>
<a name="405"/>  405: <i>%%--------------------------------------------------------------------</i>
<a name="406"/>  406: 
<a name="rosteritem_rw-1"/><a name="407"/>  407: <b>rosteritem_rw</b>(Config) -&gt;
<a name="408"/>  408:     escalus:story(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="409"/>  409:                 {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="410"/>  410:                 {BobName, Domain, _} = get_user_data(bob, Config),
<a name="411"/>  411:                 {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="412"/>  412: 
<a name="413"/>  413:                 {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName,
<a name="414"/>  414:                                                         Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="415"/>  415:                 {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="416"/>  416:                                                         Domain, &quot;\&quot;My Mike\&quot;&quot;, &quot;\'My Group\'&quot;, &quot;both&quot;], Config),
<a name="417"/>  417: 
<a name="418"/>  418:                 [Push1, Push2] = escalus:wait_for_stanzas(Alice, 2), % Check roster broadcasts
<a name="419"/>  419:                 escalus:assert(is_roster_set, Push1),
<a name="420"/>  420:                 escalus:assert(roster_contains, [bob], Push1),
<a name="421"/>  421:                 escalus:assert(is_roster_set, Push2),
<a name="422"/>  422:                 escalus:assert(roster_contains, [mike], Push2),
<a name="423"/>  423: 
<a name="424"/>  424:                 {Items1, 0} = ejabberdctl(&quot;get_roster&quot;, [AliceName, Domain], Config),
<a name="425"/>  425:                 match_roster([{BobName, Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;},
<a name="426"/>  426:                               {MikeName, Domain, &quot;MyMike&quot;, &quot;MyGroup&quot;, &quot;both&quot;}], Items1),
<a name="427"/>  427: 
<a name="428"/>  428:                 escalus:send(Alice, escalus_stanza:roster_get()),
<a name="429"/>  429:                 Roster1 = escalus:wait_for_stanza(Alice),
<a name="430"/>  430:                 escalus:assert(is_roster_result, Roster1),
<a name="431"/>  431:                 escalus:assert(roster_contains, [bob], Roster1),
<a name="432"/>  432:                 escalus:assert(roster_contains, [mike], Roster1),
<a name="433"/>  433: 
<a name="434"/>  434:                 {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, BobName, Domain], Config),
<a name="435"/>  435: 
<a name="436"/>  436:                 Push3 = escalus:wait_for_stanza(Alice),
<a name="437"/>  437:                 escalus:assert(is_roster_set, Push3),
<a name="438"/>  438:                 escalus:assert(roster_contains, [bob], Push3),
<a name="439"/>  439: 
<a name="440"/>  440:                 {Items2, 0} = ejabberdctl(&quot;get_roster&quot;, [AliceName, Domain], Config),
<a name="441"/>  441:                 match_roster([{MikeName, Domain, &quot;MyMike&quot;, &quot;MyGroup&quot;, &quot;both&quot;}], Items2),
<a name="442"/>  442: 
<a name="443"/>  443:                 escalus:send(Alice, escalus_stanza:roster_remove_contact(mike))  % cleanup
<a name="444"/>  444:         end).
<a name="445"/>  445: 
<a name="presence_after_add_rosteritem-1"/><a name="446"/>  446: <b>presence_after_add_rosteritem</b>(Config) -&gt;
<a name="447"/>  447:      escalus:story(Config, [{alice, 1}, {bob,1}], fun(Alice, Bob) -&gt;
<a name="448"/>  448:                  {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="449"/>  449:                  {BobName, Domain, _} = get_user_data(bob, Config),
<a name="450"/>  450: 
<a name="451"/>  451:                  {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName,
<a name="452"/>  452:                                                          Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="453"/>  453: 
<a name="454"/>  454:                  escalus:send(Alice, escalus_stanza:presence(&lt;&lt;&quot;available&quot;&gt;&gt;)),
<a name="455"/>  455:                  escalus:assert(is_presence, escalus:wait_for_stanza(Bob)),
<a name="456"/>  456: 
<a name="457"/>  457:                  escalus:send(Alice, escalus_stanza:roster_remove_contact(bob))  % cleanup
<a name="458"/>  458:          end).
<a name="459"/>  459: 
<a name="push_roster-1"/><a name="460"/>  460: <b>push_roster</b>(Config) -&gt;
<a name="461"/>  461:     escalus:story(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="462"/>  462:                 {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="463"/>  463:                 TemplatePath = escalus_config:get_config(roster_template, Config),
<a name="464"/>  464: 
<a name="465"/>  465:                 {_, 0} = ejabberdctl(&quot;push_roster&quot;, [TemplatePath, AliceName, Domain], Config),
<a name="466"/>  466:                 escalus:send(Alice, escalus_stanza:roster_get()),
<a name="467"/>  467:                 Roster1 = escalus:wait_for_stanza(Alice),
<a name="468"/>  468:                 escalus:assert(is_roster_result, Roster1),
<a name="469"/>  469:                 escalus:assert(roster_contains, [bob], Roster1),
<a name="470"/>  470: 
<a name="471"/>  471:                 escalus:send(Alice, escalus_stanza:roster_remove_contact(bob)) % cleanup
<a name="472"/>  472:         end).
<a name="473"/>  473: 
<a name="process_rosteritems_list_simple-1"/><a name="474"/>  474: <b>process_rosteritems_list_simple</b>(Config) -&gt;
<a name="475"/>  475:     escalus:story(Config, [{alice, 1}, {bob, 1}], fun(Alice, Bob) -&gt;
<a name="476"/>  476:         %% given
<a name="477"/>  477:         Action = &quot;list&quot;,
<a name="478"/>  478:         Subs = &quot;any&quot;,
<a name="479"/>  479:         Asks = &quot;any&quot;,
<a name="480"/>  480:         User = escalus_client:short_jid(Alice),
<a name="481"/>  481:         Contact =string:to_lower(binary_to_list(escalus_client:short_jid(Bob))),
<a name="482"/>  482:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="483"/>  483:         {BobName, Domain, _} = get_user_data(bob, Config),
<a name="484"/>  484:         %% when
<a name="485"/>  485:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName, Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="486"/>  486:         S = escalus:wait_for_stanzas(Alice, 2),
<a name="487"/>  487:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, Contact], Config),
<a name="488"/>  488:         %% then
<a name="489"/>  489:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++Contact++&quot;.*&quot;),
<a name="490"/>  490:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, BobName, Domain], Config)
<a name="491"/>  491:     end).
<a name="492"/>  492: 
<a name="process_rosteritems_list_nomatch-1"/><a name="493"/>  493: <b>process_rosteritems_list_nomatch</b>(Config) -&gt;
<a name="494"/>  494:     escalus:story(Config, [{alice, 1}, {bob, 1}], fun(Alice, Bob) -&gt;
<a name="495"/>  495:         %% given
<a name="496"/>  496:         Action = &quot;list&quot;,
<a name="497"/>  497:         Subs = &quot;from:both&quot;,
<a name="498"/>  498:         Asks = &quot;any&quot;,
<a name="499"/>  499:         User = escalus_client:short_jid(Alice),
<a name="500"/>  500:         Contact =string:to_lower(binary_to_list(escalus_client:short_jid(Bob))),
<a name="501"/>  501:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="502"/>  502:         {BobName, Domain, _} = get_user_data(bob, Config),
<a name="503"/>  503:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName,
<a name="504"/>  504:                                                 Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;to&quot;], Config),
<a name="505"/>  505:         escalus:wait_for_stanzas(Alice, 2),
<a name="506"/>  506:         %% when
<a name="507"/>  507:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, Contact], Config),
<a name="508"/>  508:         %% then
<a name="509"/>  509:         nomatch = re:run(R, &quot;.*Matches:.*&quot;++Contact++&quot;.*&quot;),
<a name="510"/>  510:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, BobName, Domain], Config)
<a name="511"/>  511:     end).
<a name="512"/>  512: 
<a name="process_rosteritems_list_advanced1-1"/><a name="513"/>  513: <b>process_rosteritems_list_advanced1</b>(Config) -&gt;
<a name="514"/>  514:     escalus:story(Config, [{alice, 1}, {mike, 1}, {kate, 1}], fun(Alice, Mike, Kate) -&gt;
<a name="515"/>  515:         %% given
<a name="516"/>  516:         Action = &quot;list&quot;,
<a name="517"/>  517:         Subs = &quot;from:both&quot;,
<a name="518"/>  518:         Asks = &quot;any&quot;,
<a name="519"/>  519:         User = escalus_client:short_jid(Alice),
<a name="520"/>  520:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="521"/>  521:         {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="522"/>  522:         {KateName, Domain, _} = get_user_data(kate, Config),
<a name="523"/>  523:         ContactMike = string:to_lower(binary_to_list(escalus_client:short_jid(Mike))),
<a name="524"/>  524:         ContactKate= string:to_lower(binary_to_list(escalus_client:short_jid(Kate))),
<a name="525"/>  525:         ContactsRegexp = ContactMike ++ &quot;:&quot; ++ string:substr(binary_to_list(KateName), 1, 2) ++ &quot;.*@.*&quot;,
<a name="526"/>  526: 
<a name="527"/>  527:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="528"/>  528:                                                 Domain, &quot;DearMike&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="529"/>  529:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, KateName,
<a name="530"/>  530:                                                 Domain, &quot;BestFriend&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="531"/>  531:         escalus:wait_for_stanzas(Alice,4),
<a name="532"/>  532:         %% when
<a name="533"/>  533:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, ContactsRegexp], Config),
<a name="534"/>  534:         %% then
<a name="535"/>  535:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactMike++&quot;.*&quot;),
<a name="536"/>  536:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactKate++&quot;.*&quot;),
<a name="537"/>  537:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, MikeName, Domain], Config),
<a name="538"/>  538:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, KateName, Domain], Config)
<a name="539"/>  539:     end).
<a name="540"/>  540: 
<a name="process_rosteritems_delete_advanced-1"/><a name="541"/>  541: <b>process_rosteritems_delete_advanced</b>(Config) -&gt;
<a name="542"/>  542:     escalus:story(Config, [{alice, 1}, {mike, 1}, {kate, 1}], fun(Alice, Mike, Kate) -&gt;
<a name="543"/>  543:         %% given
<a name="544"/>  544:         Action = &quot;delete&quot;,
<a name="545"/>  545:         Subs = &quot;from&quot;,
<a name="546"/>  546:         Asks = &quot;any&quot;,
<a name="547"/>  547:         User = escalus_client:short_jid(Alice),
<a name="548"/>  548:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="549"/>  549:         {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="550"/>  550:         {KateName, Domain, _} = get_user_data(kate, Config),
<a name="551"/>  551:         ContactMike = string:to_lower(binary_to_list(escalus_client:short_jid(Mike))),
<a name="552"/>  552:         ContactKate= string:to_lower(binary_to_list(escalus_client:short_jid(Kate))),
<a name="553"/>  553:         ContactsRegexp = &quot;.*&quot; ++ string:substr(ContactMike, 3) ++
<a name="554"/>  554:                            &quot;:&quot; ++ string:substr(ContactKate, 1,2) ++&quot;@&quot; ++ binary_to_list(Domain),
<a name="555"/>  555:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="556"/>  556:                                                 Domain, &quot;DearMike&quot;, &quot;MyGroup&quot;, &quot;from&quot;], Config),
<a name="557"/>  557:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, KateName,
<a name="558"/>  558:                                                 Domain, &quot;Friend&quot;, &quot;MyGroup&quot;, &quot;from&quot;], Config),
<a name="559"/>  559:         escalus:wait_for_stanzas(Alice,4),
<a name="560"/>  560:         %% when
<a name="561"/>  561:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, ContactsRegexp], Config),
<a name="562"/>  562:         %% then
<a name="563"/>  563:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactMike++&quot;.*&quot;),
<a name="564"/>  564:         nomatch = re:run(R, &quot;.*Matches:.*&quot;++ContactKate++&quot;.*&quot;),
<a name="565"/>  565:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, MikeName, Domain], Config),
<a name="566"/>  566:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, KateName, Domain], Config)
<a name="567"/>  567:     end).
<a name="568"/>  568: 
<a name="process_rosteritems_list_advanced2-1"/><a name="569"/>  569: <b>process_rosteritems_list_advanced2</b>(Config) -&gt;
<a name="570"/>  570:     escalus:story(Config, [{alice, 1}, {mike, 1}, {kate, 1}], fun(Alice, Mike, Kate) -&gt;
<a name="571"/>  571:         %% given
<a name="572"/>  572:         Action = &quot;list&quot;,
<a name="573"/>  573:         Subs = &quot;any&quot;,
<a name="574"/>  574:         Asks = &quot;any&quot;,
<a name="575"/>  575:         User = escalus_client:short_jid(Alice),
<a name="576"/>  576:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="577"/>  577:         {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="578"/>  578:         {KateName, Domain, _} = get_user_data(kate, Config),
<a name="579"/>  579:         ContactMike = string:to_lower(binary_to_list(escalus_client:short_jid(Mike))),
<a name="580"/>  580:         ContactKate= string:to_lower(binary_to_list(escalus_client:short_jid(Kate))),
<a name="581"/>  581:         ContactsRegexp = &quot;.*e@lo.*&quot;,
<a name="582"/>  582:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="583"/>  583:                                                 Domain, &quot;DearMike&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="584"/>  584:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, KateName,
<a name="585"/>  585:                                                 Domain, &quot;KateFromSchool&quot;, &quot;MyGroup&quot;, &quot;from&quot;], Config),
<a name="586"/>  586:         escalus:wait_for_stanzas(Alice,4),
<a name="587"/>  587:         %% when
<a name="588"/>  588:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, ContactsRegexp], Config),
<a name="589"/>  589:         %% then
<a name="590"/>  590:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactMike++&quot;.*&quot;),
<a name="591"/>  591:         {match, _} = re:run(R, &quot;.*Matches:.*&quot;++ContactKate++&quot;.*&quot;),
<a name="592"/>  592:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, MikeName, Domain], Config),
<a name="593"/>  593:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, KateName, Domain], Config)
<a name="594"/>  594:     end).
<a name="595"/>  595: 
<a name="process_rosteritems_delete_advanced2-1"/><a name="596"/>  596: <b>process_rosteritems_delete_advanced2</b>(Config) -&gt;
<a name="597"/>  597:     escalus:story(Config, [{alice, 1}, {bob, 1}, {mike, 1}, {kate, 1}], fun(Alice, Bob, Mike, Kate) -&gt;
<a name="598"/>  598:         %% given
<a name="599"/>  599:         Action = &quot;delete&quot;,
<a name="600"/>  600:         Subs = &quot;to:from&quot;,
<a name="601"/>  601:         Asks = &quot;any&quot;,
<a name="602"/>  602:         User = &quot;'al.c[e]@.*host:((b[o]b)|(mike))@loc.*t2'&quot;,
<a name="603"/>  603:         {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="604"/>  604:         {BobName, Domain, _} = get_user_data(bob, Config),
<a name="605"/>  605:         {MikeName, Domain, _} = get_user_data(mike, Config),
<a name="606"/>  606:         {KateName, Domain, _} = get_user_data(kate, Config),
<a name="607"/>  607:         ContactMike = string:to_lower(binary_to_list(escalus_client:short_jid(Mike))),
<a name="608"/>  608:         ContactKate= string:to_lower(binary_to_list(escalus_client:short_jid(Kate))),
<a name="609"/>  609:         ContactBob= string:to_lower(binary_to_list(escalus_client:short_jid(Bob))),
<a name="610"/>  610:         ContactsReg = &quot;'.ik[ea]@localho+.*:k@loc.*st:(alice)+@.*:no'&quot;,
<a name="611"/>  611:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, MikeName,
<a name="612"/>  612:                                                 Domain, &quot;DearMike&quot;, &quot;MyGroup&quot;, &quot;to&quot;], Config),
<a name="613"/>  613:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, KateName,
<a name="614"/>  614:                                                 Domain, &quot;HateHerSheHasSoNiceLegs&quot;, &quot;MyGroup&quot;, &quot;to&quot;], Config),
<a name="615"/>  615:         {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [BobName, Domain, AliceName,
<a name="616"/>  616:                                                 Domain, &quot;Girlfriend&quot;, &quot;MyGroup&quot;, &quot;from&quot;], Config),
<a name="617"/>  617:         escalus:wait_for_stanzas(Alice,4),
<a name="618"/>  618:         escalus:wait_for_stanzas(Bob, 2),
<a name="619"/>  619:         %% when
<a name="620"/>  620:         {R, 0} = ejabberdctl(&quot;process_rosteritems&quot;, [Action, Subs, Asks, User, ContactsReg], Config),
<a name="621"/>  621:         %% then
<a name="622"/>  622:         {match, _} = re:run(R, &quot;.*Matches:.*&quot; ++ ContactMike ++ &quot;.*&quot;),
<a name="623"/>  623:         nomatch = re:run(R, &quot;.*Matches:.*&quot; ++ ContactKate ++ &quot;.*&quot;),
<a name="624"/>  624:         nomatch = re:run(R, &quot;.*Matches:.*&quot; ++ ContactBob ++ &quot;.*&quot;),
<a name="625"/>  625:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, MikeName, Domain], Config),
<a name="626"/>  626:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, KateName, Domain], Config),
<a name="627"/>  627:         {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [BobName, Domain, AliceName, Domain], Config)
<a name="628"/>  628:     end).
<a name="629"/>  629: 
<a name="push_roster_all-1"/><a name="630"/>  630: <b>push_roster_all</b>(Config) -&gt;
<a name="631"/>  631:     escalus:story(Config, [{alice, 1}, {bob,1}], fun(Alice, Bob) -&gt;
<a name="632"/>  632:                 TemplatePath = escalus_config:get_config(roster_template, Config),
<a name="633"/>  633: 
<a name="634"/>  634:                 {_, 0} = ejabberdctl(&quot;push_roster_all&quot;, [TemplatePath], Config),
<a name="635"/>  635: 
<a name="636"/>  636:                 escalus:send(Alice, escalus_stanza:roster_get()),
<a name="637"/>  637:                 Roster1 = escalus:wait_for_stanza(Alice),
<a name="638"/>  638:                 escalus:assert(is_roster_result, Roster1),
<a name="639"/>  639:                 escalus:assert(roster_contains, [bob], Roster1),
<a name="640"/>  640: 
<a name="641"/>  641:                 escalus:send(Bob, escalus_stanza:roster_get()),
<a name="642"/>  642:                 Roster2 = escalus:wait_for_stanza(Bob),
<a name="643"/>  643:                 escalus:assert(is_roster_result, Roster2),
<a name="644"/>  644:                 escalus:assert(roster_contains, [alice], Roster2),
<a name="645"/>  645: 
<a name="646"/>  646:                 escalus:send(Alice, escalus_stanza:roster_remove_contact(bob)), % cleanup
<a name="647"/>  647:                 escalus:send(Bob, escalus_stanza:roster_remove_contact(alice)) % cleanup
<a name="648"/>  648:         end).
<a name="649"/>  649: 
<a name="push_roster_alltoall-1"/><a name="650"/>  650: <b>push_roster_alltoall</b>(Config) -&gt;
<a name="651"/>  651:     escalus:story(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="652"/>  652:                 {_, Domain, _} = get_user_data(alice, Config),
<a name="653"/>  653: 
<a name="654"/>  654:                 {_, 0} = ejabberdctl(&quot;push_roster_alltoall&quot;, [Domain, &quot;MyGroup&quot;], Config),
<a name="655"/>  655: 
<a name="656"/>  656:                 escalus:send(Alice, escalus_stanza:roster_get()),
<a name="657"/>  657:                 Roster = escalus:wait_for_stanza(Alice),
<a name="658"/>  658: 
<a name="659"/>  659:                 escalus:assert(is_roster_result, Roster),
<a name="660"/>  660:                 escalus:assert(roster_contains, [bob], Roster),
<a name="661"/>  661:                 escalus:assert(roster_contains, [mike], Roster),
<a name="662"/>  662:                 escalus:assert(roster_contains, [kate], Roster)
<a name="663"/>  663:         end).
<a name="664"/>  664: 
<a name="665"/>  665: <i>%%--------------------------------------------------------------------</i>
<a name="666"/>  666: <i>%% mod_admin_extra_last tests</i>
<a name="667"/>  667: <i>%%--------------------------------------------------------------------</i>
<a name="668"/>  668: 
<a name="set_last-1"/><a name="669"/>  669: <b>set_last</b>(Config) -&gt;
<a name="670"/>  670:     escalus:story(Config, [{alice, 1}], fun(Alice) -&gt;
<a name="671"/>  671:                 {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="672"/>  672:                 {BobName, Domain, _} = get_user_data(bob, Config),
<a name="673"/>  673: 
<a name="674"/>  674:                 {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [AliceName, Domain, BobName,
<a name="675"/>  675:                                                         Domain, &quot;MyBob&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="676"/>  676:                 {_, 0} = ejabberdctl(&quot;add_rosteritem&quot;, [BobName, Domain, AliceName,
<a name="677"/>  677:                                                         Domain, &quot;MyAlice&quot;, &quot;MyGroup&quot;, &quot;both&quot;], Config),
<a name="678"/>  678: 
<a name="679"/>  679:                 escalus:wait_for_stanza(Alice), % ignore push
<a name="680"/>  680: 
<a name="681"/>  681:                 {Mega, Secs, _} = erlang:now(),
<a name="682"/>  682:                 TS = integer_to_list(Mega*1000000+Secs-7200),
<a name="683"/>  683: 
<a name="684"/>  684:                 {_, 0} = ejabberdctl(&quot;set_last&quot;, [BobName, Domain, TS, &quot;Status&quot;], Config),
<a name="685"/>  685: 
<a name="686"/>  686:                 escalus:send(Alice, escalus_stanza:last_activity(bob)),
<a name="687"/>  687:                 LastAct = escalus:wait_for_stanza(Alice),
<a name="688"/>  688:                 escalus:assert(is_last_result, LastAct),
<a name="689"/>  689:                 Seconds = list_to_integer(binary_to_list(
<a name="690"/>  690:                             exml_query:path(LastAct, [{element, &lt;&lt;&quot;query&quot;&gt;&gt;}, {attr, &lt;&lt;&quot;seconds&quot;&gt;&gt;}]))),
<a name="691"/>  691:                 true = ( (Seconds &gt; 7100) andalso (Seconds &lt; 7300) ),
<a name="692"/>  692: 
<a name="693"/>  693:                 {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [AliceName, Domain, BobName, Domain], Config), % cleanup
<a name="694"/>  694:                 {_, 0} = ejabberdctl(&quot;delete_rosteritem&quot;, [BobName, Domain, AliceName, Domain], Config)
<a name="695"/>  695:         end).
<a name="696"/>  696: 
<a name="697"/>  697: <i>%%--------------------------------------------------------------------</i>
<a name="698"/>  698: <i>%% mod_admin_extra_private tests</i>
<a name="699"/>  699: <i>%%--------------------------------------------------------------------</i>
<a name="700"/>  700: 
<a name="private_rw-1"/><a name="701"/>  701: <b>private_rw</b>(Config) -&gt;
<a name="702"/>  702:     {AliceName, Domain, _} = get_user_data(alice, Config),
<a name="703"/>  703:     XmlEl1 = &quot;'&lt;secretinfo xmlns=\&quot;nejmspejs\&quot;&gt;1&lt;/secretinfo&gt;'&quot;,
<a name="704"/>  704:     XmlEl2 = &quot;'&lt;secretinfo xmlns=\&quot;inny\&quot;&gt;2&lt;/secretinfo&gt;'&quot;,
<a name="705"/>  705: 
<a name="706"/>  706:     {_, 0} = ejabberdctl(&quot;private_set&quot;, [AliceName, Domain, XmlEl1], Config),
<a name="707"/>  707:     {_, 0} = ejabberdctl(&quot;private_set&quot;, [AliceName, Domain, XmlEl2], Config),
<a name="708"/>  708: 
<a name="709"/>  709:     {Result, 0} = ejabberdctl(&quot;private_get&quot;, [AliceName, Domain, &quot;secretinfo&quot;, &quot;nejmspejs&quot;], Config),
<a name="710"/>  710:     {ok, #xmlel{ name = &lt;&lt;&quot;secretinfo&quot;&gt;&gt;, attrs = [{&lt;&lt;&quot;xmlns&quot;&gt;&gt;, &lt;&lt;&quot;nejmspejs&quot;&gt;&gt;}],
<a name="711"/>  711:                 children = [#xmlcdata{ content = &lt;&lt;&quot;1&quot;&gt;&gt; }]}} = exml:parse(list_to_binary(Result)).
<a name="712"/>  712: 
<a name="713"/>  713: <i>%%--------------------------------------------------------------------</i>
<a name="714"/>  714: <i>%% mod_admin_extra_stanza tests</i>
<a name="715"/>  715: <i>%%--------------------------------------------------------------------</i>
<a name="716"/>  716: 
<a name="send_message-1"/><a name="717"/>  717: <b>send_message</b>(Config) -&gt;
<a name="718"/>  718:     escalus:story(Config, [{alice, 1}, {bob, 2}], fun(Alice, Bob1, Bob2) -&gt;
<a name="719"/>  719:                 {_, 0} = ejabberdctl(&quot;send_message_chat&quot;, [escalus_client:full_jid(Alice),
<a name="720"/>  720:                                                            escalus_client:full_jid(Bob1),
<a name="721"/>  721:                                                            &quot;\&quot;Hi Bob!\&quot;&quot;], Config),
<a name="722"/>  722:                 Stanza1 = escalus:wait_for_stanza(Bob1),
<a name="723"/>  723:                 escalus:assert(is_chat_message, [&lt;&lt;&quot;Hi Bob!&quot;&gt;&gt;], Stanza1),
<a name="724"/>  724: 
<a name="725"/>  725:                 {_, 0} = ejabberdctl(&quot;send_message_headline&quot;, [escalus_client:full_jid(Alice),
<a name="726"/>  726:                                                                     escalus_client:short_jid(Bob1),
<a name="727"/>  727:                                                                     &quot;Subj&quot;, &quot;\&quot;Hi Bob!!\&quot;&quot;], Config),
<a name="728"/>  728:                 Stanza2 = escalus:wait_for_stanza(Bob1),
<a name="729"/>  729:                 Stanza3 = escalus:wait_for_stanza(Bob2),
<a name="730"/>  730:                 escalus:assert(is_headline_message, [&lt;&lt;&quot;Subj&quot;&gt;&gt;, &lt;&lt;&quot;Hi Bob!!&quot;&gt;&gt;], Stanza2),
<a name="731"/>  731:                 escalus:assert(is_headline_message, [&lt;&lt;&quot;Subj&quot;&gt;&gt;, &lt;&lt;&quot;Hi Bob!!&quot;&gt;&gt;], Stanza3)
<a name="732"/>  732:         end).
<a name="733"/>  733: 
<a name="send_message_wrong_jid-1"/><a name="734"/>  734: <b>send_message_wrong_jid</b>(Config) -&gt;
<a name="735"/>  735:     escalus:story(Config, [{alice, 1}, {bob, 1}], fun(Alice, Bob) -&gt;
<a name="736"/>  736:         {_, Err1} = ejabberdctl(&quot;send_message_chat&quot;, [&quot;'@@#$%!!.'&quot;,
<a name="737"/>  737:                                                    escalus_client:full_jid(Bob),
<a name="738"/>  738:                                                    &quot;\&quot;Hello bobby!\&quot;&quot;], Config),
<a name="739"/>  739:         {_, Err2} = ejabberdctl(&quot;send_message_headline&quot;, [&quot;'%%@&amp;@&amp;@==//\///'&quot;,
<a name="740"/>  740:                                                        escalus_client:short_jid(Bob),
<a name="741"/>  741:                                                        &quot;Subj&quot;, &quot;\&quot;Are
<a name="742"/>  742:                                                        you there?\&quot;&quot;],
<a name="743"/>  743:                              Config),
<a name="744"/>  744:         true = Err1 =/= 0,
<a name="745"/>  745:         true = Err2 =/= 0,
<a name="746"/>  746:         escalus_assert:has_no_stanzas(Alice),
<a name="747"/>  747:         escalus_assert:has_no_stanzas(Bob)
<a name="748"/>  748:     end).
<a name="749"/>  749: 
<a name="send_stanza-1"/><a name="750"/>  750: <b>send_stanza</b>(Config) -&gt;
<a name="751"/>  751:     escalus:story(Config, [{alice, 1}, {bob,1}], fun(Alice, Bob) -&gt;
<a name="752"/>  752:                 Domain = escalus_client:server(Alice),
<a name="753"/>  753:                 Resource = escalus_client:resource(Alice),
<a name="754"/>  754:                 {BobName, _, _} = get_user_data(bob, Config),
<a name="755"/>  755:                 BobJID = &lt;&lt;BobName/binary, $@, Domain/binary, $/, (escalus_client:resource(Bob))/binary&gt;&gt;,
<a name="756"/>  756: 
<a name="757"/>  757:                 Stanza = re:replace(exml:to_binary(escalus_stanza:from(escalus_stanza:chat_to(Alice, &quot;Hi&quot;), BobJID)),
<a name="758"/>  758:                                     &lt;&lt;?DOUBLE_QUOTE_CHAR&gt;&gt;, &lt;&lt;?SINGLE_QUOTE_CHAR&gt;&gt;, [global, {return, binary}]),
<a name="759"/>  759:                 {_, 0} = ejabberdctl(&quot;send_stanza_c2s&quot;, [BobName, Domain, Resource, &lt;&lt;$\&quot;, Stanza/binary, $\&quot;&gt;&gt;], Config),
<a name="760"/>  760: 
<a name="761"/>  761:                 Message = escalus:wait_for_stanza(Alice),
<a name="762"/>  762:                 escalus:assert(is_chat_message, [&lt;&lt;&quot;Hi&quot;&gt;&gt;], Message),
<a name="763"/>  763:                 escalus:assert(is_stanza_from, [Bob], Message)
<a name="764"/>  764:         end).
<a name="765"/>  765: 
<a name="send_stanzac2s_wrong-1"/><a name="766"/>  766: <b>send_stanzac2s_wrong</b>(Config) -&gt;
<a name="767"/>  767:     escalus:story(Config, [{alice, 1}, {bob,1}], fun(Alice, Bob) -&gt;
<a name="768"/>  768:         Domain = escalus_client:server(Alice),
<a name="769"/>  769:         Resource = escalus_client:resource(Alice),
<a name="770"/>  770:         WrongBobName = &quot;bobby_the_great&quot;,
<a name="771"/>  771:         {BobName, _, _} = get_user_data(bob, Config),
<a name="772"/>  772:         BobJID = &lt;&lt;BobName/binary, $@, Domain/binary, $/, (escalus_client:resource(Bob))/binary&gt;&gt;,
<a name="773"/>  773:         Stanza = re:replace(exml:to_binary(escalus_stanza:from(escalus_stanza:chat_to(Alice, &quot;Hi&quot;), BobJID)),
<a name="774"/>  774:                             &lt;&lt;?DOUBLE_QUOTE_CHAR&gt;&gt;, &lt;&lt;?SINGLE_QUOTE_CHAR&gt;&gt;, [global, {return, binary}]),
<a name="775"/>  775:         StanzaWrong = &lt;&lt;&quot;&lt;iq type='get' id='234234'&gt;&lt;xmlns='wrongwrong'&gt;&quot;&gt;&gt;,
<a name="776"/>  776:         {_, Err} = ejabberdctl(&quot;send_stanza_c2s&quot;, [WrongBobName, Domain, Resource, &lt;&lt;$\&quot;, Stanza/binary, $\&quot;&gt;&gt;],
<a name="777"/>  777:                                Config),
<a name="778"/>  778:         {_, Err2} = ejabberdctl(&quot;send_stanza_c2s&quot;, [BobName, Domain, Resource, &lt;&lt;$\&quot;, StanzaWrong/binary, $\&quot;&gt;&gt;],
<a name="779"/>  779:                                Config),
<a name="780"/>  780: 
<a name="781"/>  781:         true = Err =/= 0,
<a name="782"/>  782:         true = Err2 =/= 0,
<a name="783"/>  783:         escalus_assert:has_no_stanzas(Alice)
<a name="784"/>  784:     end).
<a name="785"/>  785: 
<a name="786"/>  786: <i>%%--------------------------------------------------------------------</i>
<a name="787"/>  787: <i>%% mod_admin_extra_stats tests</i>
<a name="788"/>  788: <i>%%--------------------------------------------------------------------</i>
<a name="789"/>  789: 
<a name="stats_global-1"/><a name="790"/>  790: <b>stats_global</b>(Config) -&gt;
<a name="791"/>  791:     escalus:story(Config, [{alice, 1}, {bob,1}], fun(_Alice, _Bob) -&gt;
<a name="792"/>  792:                 RegisteredCount = length(escalus_config:get_config(escalus_users, Config, [])),
<a name="793"/>  793:                 Registered = integer_to_list(RegisteredCount) ++ &quot;\n&quot;,
<a name="794"/>  794: 
<a name="795"/>  795:                 {UpTime, 0} = ejabberdctl(&quot;stats&quot;, [&quot;uptimeseconds&quot;], Config),
<a name="796"/>  796:                 _ = list_to_integer(string:strip(UpTime, both, $\n)),
<a name="797"/>  797:                 {Registered, 0} = ejabberdctl(&quot;stats&quot;, [&quot;registeredusers&quot;], Config),
<a name="798"/>  798: 
<a name="799"/>  799:                 {&quot;2\n&quot;, 0} = ejabberdctl(&quot;stats&quot;, [&quot;onlineusersnode&quot;], Config),
<a name="800"/>  800: 
<a name="801"/>  801:                 {&quot;2\n&quot;, 0} = ejabberdctl(&quot;stats&quot;, [&quot;onlineusers&quot;], Config)
<a name="802"/>  802:         end).
<a name="803"/>  803: 
<a name="stats_host-1"/><a name="804"/>  804: <b>stats_host</b>(Config) -&gt;
<a name="805"/>  805:     escalus:story(Config, [{alice, 1}, {bob,1}], fun(Alice, _Bob) -&gt;
<a name="806"/>  806:                 RegisteredCount = length(escalus_config:get_config(escalus_users, Config, [])),
<a name="807"/>  807:                 Registered = integer_to_list(RegisteredCount) ++ &quot;\n&quot;,
<a name="808"/>  808: 
<a name="809"/>  809:                 PriDomain = escalus_client:server(Alice),
<a name="810"/>  810:                 SecDomain = escalus_config:get_config(ejabberd_secondary_domain, Config),
<a name="811"/>  811: 
<a name="812"/>  812:                 {Registered, 0} = ejabberdctl(&quot;stats_host&quot;, [&quot;registeredusers&quot;, PriDomain], Config),
<a name="813"/>  813:                 {&quot;0\n&quot;, 0} = ejabberdctl(&quot;stats_host&quot;, [&quot;registeredusers&quot;, SecDomain], Config),
<a name="814"/>  814: 
<a name="815"/>  815:                 {&quot;2\n&quot;, 0} = ejabberdctl(&quot;stats_host&quot;, [&quot;onlineusers&quot;, PriDomain], Config),
<a name="816"/>  816:                 {&quot;0\n&quot;, 0} = ejabberdctl(&quot;stats_host&quot;, [&quot;onlineusers&quot;, SecDomain], Config)
<a name="817"/>  817:         end).
<a name="818"/>  818: 
<a name="819"/>  819: 
<a name="820"/>  820: 
<a name="821"/>  821: <i>%%-----------------------------------------------------------------</i>
<a name="822"/>  822: <i>%% Improve coverage</i>
<a name="823"/>  823: <i>%%-----------------------------------------------------------------</i>
<a name="824"/>  824: 
<a name="825"/>  825: 
<a name="826"/>  826: 
<a name="simple_register-1"/><a name="827"/>  827: <b>simple_register</b>(Config) -&gt;
<a name="828"/>  828:     %% given
<a name="829"/>  829:     Domain = escalus_ct:get_config(ejabberd_domain),
<a name="830"/>  830:     {Name, Password} = {&lt;&lt;&quot;tyler&quot;&gt;&gt;, &lt;&lt;&quot;durden&quot;&gt;&gt;},
<a name="831"/>  831:     %% when
<a name="832"/>  832:     {_, 0} = ejabberdctl(&quot;register&quot;, [Name, Domain, Password], Config),
<a name="833"/>  833:     {R2, 0} = ejabberdctl(&quot;registered_users&quot;, [Domain], Config),
<a name="834"/>  834:     %% then
<a name="835"/>  835:     {match, _} = re:run(R2, &quot;.*(&quot; ++binary_to_list(Name)++&quot;).*&quot;).
<a name="836"/>  836: 
<a name="simple_unregister-1"/><a name="837"/>  837: <b>simple_unregister</b>(Config) -&gt;
<a name="838"/>  838:     %% given
<a name="839"/>  839:     Domain = escalus_ct:get_config(ejabberd_domain),
<a name="840"/>  840:     {Name, _} = {&lt;&lt;&quot;tyler&quot;&gt;&gt;, &lt;&lt;&quot;durden&quot;&gt;&gt;},
<a name="841"/>  841:     %% when
<a name="842"/>  842:     {_, 0} = ejabberdctl(&quot;unregister&quot;, [Name, Domain], Config),
<a name="843"/>  843:     {R2, 0} = ejabberdctl(&quot;registered_users&quot;, [Domain], Config),
<a name="844"/>  844:     %% then
<a name="845"/>  845:     nomatch = re:run(R2, &quot;.*(&quot; ++binary_to_list(Name)++&quot;).*&quot;).
<a name="846"/>  846: 
<a name="register_twice-1"/><a name="847"/>  847: <b>register_twice</b>(Config) -&gt;
<a name="848"/>  848:     %% given
<a name="849"/>  849:     Domain = escalus_ct:get_config(ejabberd_domain),
<a name="850"/>  850:     {Name,  Password} = {&lt;&lt;&quot;tyler&quot;&gt;&gt;, &lt;&lt;&quot;durden&quot;&gt;&gt;},
<a name="851"/>  851:     %% when
<a name="852"/>  852:     {_, 0} = ejabberdctl(&quot;register&quot;, [Name, Domain, Password], Config),
<a name="853"/>  853:     {R, Code} = ejabberdctl(&quot;register&quot;, [Name, Domain, Password], Config),
<a name="854"/>  854:     %% then
<a name="855"/>  855:     {match, _} = re:run(R, &quot;.*(already registered).*&quot;),
<a name="856"/>  856:     true = (Code =/= 0),
<a name="857"/>  857:     {_, 0} = ejabberdctl(&quot;unregister&quot;, [Name, Domain], Config).
<a name="858"/>  858: 
<a name="859"/>  859: 
<a name="860"/>  860: 
<a name="backup_restore_mnesia-1"/><a name="861"/>  861: <b>backup_restore_mnesia</b>(Config) -&gt;
<a name="862"/>  862:     %% given
<a name="863"/>  863:     TableName = passwd,
<a name="864"/>  864:     TableSize = rpc_call(mnesia, table_info, [TableName, size]),
<a name="865"/>  865:     io:format(&quot;Table size is ~n~p~n&quot;, [TableSize]),
<a name="866"/>  866:     %% Table passwd should not be empty
<a name="867"/>  867:     FileName = &quot;backup_mnesia.bup&quot;,
<a name="868"/>  868:     %% when
<a name="869"/>  869:     {R, 0} = ejabberdctl(&quot;backup&quot;, [FileName], Config),
<a name="870"/>  870:     nomatch = re:run(R, &quot;.+&quot;),
<a name="871"/>  871:     rpc_call(mnesia, clear_table, [TableName]),
<a name="872"/>  872:     0 = rpc_call(mnesia, table_info, [TableName, size]),
<a name="873"/>  873:     {R2, 0} = ejabberdctl(&quot;restore&quot;, [FileName], Config),
<a name="874"/>  874:     %% then
<a name="875"/>  875:     nomatch = re:run(R2, &quot;.+&quot;),
<a name="876"/>  876:     TableSize = rpc_call(mnesia, table_info, [TableName, size]).
<a name="877"/>  877: 
<a name="restore_mnesia_wrong-1"/><a name="878"/>  878: <b>restore_mnesia_wrong</b>(Config) -&gt;
<a name="879"/>  879:     FileName = &quot;file that doesnt exist13123.bup&quot;,
<a name="880"/>  880:     {R2, _} = ejabberdctl(&quot;restore&quot;, [FileName], Config),
<a name="881"/>  881:     {match, Code} = re:run(R2, &quot;.+&quot;),
<a name="882"/>  882:     true = (Code =/= 0).
<a name="883"/>  883: 
<a name="dump_and_load-1"/><a name="884"/>  884: <b>dump_and_load</b>(Config) -&gt;
<a name="885"/>  885:     FileName = &quot;dump.bup&quot;,
<a name="886"/>  886:     TableName = passwd,
<a name="887"/>  887:     %% Table passwd should not be empty
<a name="888"/>  888:     TableSize = rpc_call(mnesia, table_info, [TableName, size]),
<a name="889"/>  889:     {_, 0} = ejabberdctl(&quot;dump&quot;, [FileName], Config),
<a name="890"/>  890:     rpc_call(mnesia, clear_table, [TableName]),
<a name="891"/>  891:     0 = rpc_call(mnesia, table_info, [TableName, size]),
<a name="892"/>  892:     {R, 0} = ejabberdctl(&quot;load&quot;, [FileName], Config),
<a name="893"/>  893:     {match, _} = re:run(R, &quot;.+&quot;),
<a name="894"/>  894:     TableSize = rpc_call(mnesia, table_info, [TableName, size]).
<a name="895"/>  895: 
<a name="load_mnesia_wrong-1"/><a name="896"/>  896: <b>load_mnesia_wrong</b>(Config) -&gt;
<a name="897"/>  897:     FileName = &quot;file that doesnt existRHCP.bup&quot;,
<a name="898"/>  898:     {R2, Code} = ejabberdctl(&quot;restore&quot;, [FileName], Config),
<a name="899"/>  899:     {match, _} = re:run(R2, &quot;.+&quot;),
<a name="900"/>  900:     true = (Code =/= 0).
<a name="901"/>  901: 
<a name="dump_table-1"/><a name="902"/>  902: <b>dump_table</b>(Config) -&gt;
<a name="903"/>  903:     FileName = &quot;dump.mn&quot;,
<a name="904"/>  904:     TableName = passwd,
<a name="905"/>  905:     %% Table passwd should not be empty
<a name="906"/>  906:     TableSize = rpc_call(mnesia, table_info, [TableName, size]),
<a name="907"/>  907:     {_, 0} = ejabberdctl(&quot;dump_table&quot;, [FileName, atom_to_list(TableName)], Config),
<a name="908"/>  908:     rpc_call(mnesia, clear_table, [TableName]),
<a name="909"/>  909:     0 = rpc_call(mnesia, table_info, [TableName, size]),
<a name="910"/>  910:     {R, 0} = ejabberdctl(&quot;load&quot;, [FileName], Config),
<a name="911"/>  911:     {match, _} = re:run(R, &quot;.+&quot;),
<a name="912"/>  912:     TableSize = rpc_call(mnesia, table_info, [TableName, size]).
<a name="913"/>  913: 
<a name="get_loglevel-1"/><a name="914"/>  914: <b>get_loglevel</b>(Config) -&gt;
<a name="915"/>  915:     {R, 0} = ejabberdctl(&quot;get_loglevel&quot;, [], Config),
<a name="916"/>  916:     LogLevel = rpc_call(ejabberd_loglevel, get, []),
<a name="917"/>  917:     RegList = [io_lib:format(&quot;(.|\n|\r)*loglevel for ~p is ~p(.|\n|\r)*&quot;, [M, Lev]) || {M, {Lev, _}} &lt;- LogLevel],
<a name="918"/>  918:     Regexp = lists:flatten(RegList),
<a name="919"/>  919:     Len = length(R),
<a name="920"/>  920:     {match, [{0, Len}]} = re:run(R, Regexp, [{capture, first}]).
<a name="921"/>  921: 
<a name="remove_old_messages_test-1"/><a name="922"/>  922: <b>remove_old_messages_test</b>(Config) -&gt;
<a name="923"/>  923:     escalus:story(Config, [{alice, 1}], fun(_) -&gt;
<a name="924"/>  924:         %% given
<a name="925"/>  925:         JidA = nick_to_jid(alice, Config),
<a name="926"/>  926:         JidB = nick_to_jid(bob, Config),
<a name="927"/>  927:         JidRecordAlice = rpc_call(jid, from_binary, [JidA]),
<a name="928"/>  928:         JidRecordBob = rpc_call(jid, from_binary, [JidB]),
<a name="929"/>  929:         Msg1 = escalus_stanza:chat_to(&lt;&lt;&quot;bob@localhost&quot;&gt;&gt;, &quot;Hi, how are you? Its old message!&quot;),
<a name="930"/>  930:         Msg2 = escalus_stanza:chat_to(&lt;&lt;&quot;bob@localhost&quot;&gt;&gt;, &quot;Hello its new message!&quot;),
<a name="931"/>  931:         OldTimestamp = fallback_timestamp(10, now()),
<a name="932"/>  932:         OfflineOld = generate_offline_message(JidRecordAlice, JidRecordBob, Msg1, OldTimestamp),
<a name="933"/>  933:         OfflineNew = generate_offline_message(JidRecordAlice, JidRecordBob, Msg2, now()),
<a name="934"/>  934:         {jid, _, _, _, LUser, LServer, _} = JidRecordBob,
<a name="935"/>  935:         rpc_call(mod_offline_backend, write_messages, [LUser, LServer, [OfflineOld, OfflineNew]]),
<a name="936"/>  936:         %% when
<a name="937"/>  937:         {_, 0} = ejabberdctl(&quot;delete_old_messages&quot;, [&quot;1&quot;], Config),
<a name="938"/>  938:         {ok, SecondList} = rpc_call(mod_offline_backend, pop_messages, [LUser, LServer]),
<a name="939"/>  939:         %% then
<a name="940"/>  940:         1 = length(SecondList)
<a name="941"/>  941:     end).
<a name="942"/>  942: 
<a name="remove_expired_messages_test-1"/><a name="943"/>  943: <b>remove_expired_messages_test</b>(Config) -&gt;
<a name="944"/>  944:     escalus:story(Config, [{mike, 1}], fun(_) -&gt;
<a name="945"/>  945:         %% given
<a name="946"/>  946:         JidA = nick_to_jid(mike, Config),
<a name="947"/>  947:         JidB = nick_to_jid(kate, Config),
<a name="948"/>  948:         JidRecordMike = rpc_call(jid, from_binary, [JidA]),
<a name="949"/>  949:         JidRecordKate = rpc_call(jid, from_binary, [JidB]),
<a name="950"/>  950:         Msg1 = escalus_stanza:chat_to(&lt;&lt;&quot;kate@localhost&quot;&gt;&gt;, &quot;Rolling stones&quot;),
<a name="951"/>  951:         Msg2 = escalus_stanza:chat_to(&lt;&lt;&quot;kate@localhost&quot;&gt;&gt;, &quot;Arctic monkeys!&quot;),
<a name="952"/>  952:         Msg3 = escalus_stanza:chat_to(&lt;&lt;&quot;kate@localhost&quot;&gt;&gt;, &quot;More wine...&quot;),
<a name="953"/>  953:         Msg4 = escalus_stanza:chat_to(&lt;&lt;&quot;kate@localhost&quot;&gt;&gt;, &quot;kings of leon&quot;),
<a name="954"/>  954:         OldTimestamp = fallback_timestamp(10, now()),
<a name="955"/>  955:         ExpirationTime = fallback_timestamp(2, now()),
<a name="956"/>  956:         ExpirationTimeFuture= fallback_timestamp(-5, now()),
<a name="957"/>  957:         OfflineOld = generate_offline_expired_message(JidRecordMike, JidRecordKate, Msg1, OldTimestamp, ExpirationTime),
<a name="958"/>  958:         OfflineNow = generate_offline_expired_message(JidRecordMike, JidRecordKate, Msg2, now(), ExpirationTime),
<a name="959"/>  959:         OfflineFuture = generate_offline_expired_message(JidRecordMike, JidRecordKate, Msg3, now(), ExpirationTimeFuture),
<a name="960"/>  960:         OfflineFuture2 = generate_offline_expired_message(JidRecordMike, JidRecordKate, Msg4, OldTimestamp, ExpirationTimeFuture),
<a name="961"/>  961:         {jid, _, _, _, LUser, LServer, _} = JidRecordKate,
<a name="962"/>  962:         rpc_call(mod_offline_backend, write_messages, [LUser, LServer, [OfflineOld, OfflineNow, OfflineFuture, OfflineFuture2]]),
<a name="963"/>  963:         %% when
<a name="964"/>  964:         {_, 0} = ejabberdctl(&quot;delete_expired_messages&quot;, [], Config),
<a name="965"/>  965:         {ok, SecondList} = rpc_call(mod_offline_backend, pop_messages, [LUser, LServer]),
<a name="966"/>  966:         %% then
<a name="967"/>  967:         2 = length(SecondList)
<a name="968"/>  968:     end).
<a name="969"/>  969: 
<a name="970"/>  970: <i>%%-----------------------------------------------------------------</i>
<a name="971"/>  971: <i>%% Helpers</i>
<a name="972"/>  972: <i>%%-----------------------------------------------------------------</i>
<a name="973"/>  973: 
<a name="974"/>  974: 
<a name="nick_to_jid-2"/><a name="975"/>  975: <b>nick_to_jid</b>(UserName, Config) when is_atom(UserName) -&gt;
<a name="976"/>  976:     UserSpec = escalus_users:get_userspec(Config, UserName),
<a name="977"/>  977:     escalus_utils:jid_to_lower(escalus_users:get_jid(Config, UserSpec)).
<a name="978"/>  978: 
<a name="generate_offline_message-4"/><a name="979"/>  979: <b>generate_offline_message</b>(From, To, Msg, TimeStamp) -&gt;
<a name="980"/>  980:     {jid, _, _, _, LUser, LServer, _} = To,
<a name="981"/>  981:     #offline_msg{us = {LUser, LServer}, timestamp = TimeStamp, expire = never, from = From, to = To, packet = Msg}.
<a name="982"/>  982: 
<a name="generate_offline_expired_message-5"/><a name="983"/>  983: <b>generate_offline_expired_message</b>(From, To, Msg, TimeStamp, ExpirationTime) -&gt;
<a name="984"/>  984:     {jid, _, _, _, LUser, LServer, _} = To,
<a name="985"/>  985:     #offline_msg{us = {LUser, LServer}, timestamp = TimeStamp, expire = ExpirationTime, from = From, to = To, packet = Msg}.
<a name="986"/>  986: 
<a name="987"/>  987: 
<a name="fallback_timestamp-2"/><a name="988"/>  988: <b>fallback_timestamp</b>(Days, {MegaSecs, Secs, _MicroSecs}) -&gt;
<a name="989"/>  989:     S = MegaSecs * 1000000 + Secs - 60 * 60 * 24 * Days,
<a name="990"/>  990:     MegaSecs1 = S div 1000000,
<a name="991"/>  991:     Secs1 = S rem 1000000,
<a name="992"/>  992:     {MegaSecs1, Secs1, 0}.
<a name="993"/>  993: 
<a name="994"/>  994: 
<a name="start_mod_admin_extra-0"/><a name="995"/>  995: <b>start_mod_admin_extra</b>() -&gt;
<a name="996"/>  996:     Domain = ct:get_config(ejabberd_domain),
<a name="997"/>  997:     ok = dynamic_modules:restart(Domain, mod_admin_extra, []).
<a name="998"/>  998: 
<a name="get_user_data-2"/><a name="999"/>  999: <b>get_user_data</b>(User, Config) when is_atom(User) -&gt;
<a name="1000"/> 1000:     get_user_data(escalus_users:get_options(Config, User, &lt;&lt;&quot;newres&quot;&gt;&gt;), Config);
<a name="1001"/> 1001: <b>get_user_data</b>(User, _Config) -&gt;
<a name="1002"/> 1002:     {_, Password} = lists:keyfind(password, 1, User),
<a name="1003"/> 1003:     {_, Username} = lists:keyfind(username, 1, User),
<a name="1004"/> 1004:     {_, Domain} = lists:keyfind(server, 1, User),
<a name="1005"/> 1005:     {Username, Domain, Password}.
<a name="1006"/> 1006: 
<a name="get_md5-1"/><a name="1007"/> 1007: <b>get_md5</b>(AccountPass) -&gt;
<a name="1008"/> 1008:     lists:flatten([io_lib:format(&quot;~.16B&quot;, [X])
<a name="1009"/> 1009:                    || X &lt;- binary_to_list(crypto:hash(md5, AccountPass))]).
<a name="get_sha-1"/><a name="1010"/> 1010: <b>get_sha</b>(AccountPass) -&gt;
<a name="1011"/> 1011:     lists:flatten([io_lib:format(&quot;~.16B&quot;, [X])
<a name="1012"/> 1012:                    || X &lt;- binary_to_list(crypto:hash(sha, AccountPass))]).
<a name="1013"/> 1013: 
<a name="set_last-3"/><a name="1014"/> 1014: <b>set_last</b>(User, Domain, TStamp) -&gt;
<a name="1015"/> 1015:     Mod = escalus_ejabberd:rpc(mod_admin_extra_last, get_lastactivity_module, [Domain]),
<a name="1016"/> 1016:     Fun = escalus_ejabberd:rpc(mod_admin_extra_last, get_lastactivity_fun, [Domain]),
<a name="1017"/> 1017:     escalus_ejabberd:rpc(Mod, Fun, [escalus_utils:jid_to_lower(User), Domain, TStamp, &lt;&lt;&gt;&gt;]).
<a name="1018"/> 1018: 
<a name="delete_users-1"/><a name="1019"/> 1019: <b>delete_users</b>(Config) -&gt;
<a name="1020"/> 1020:     Users = escalus_users:get_users([alice, bob, kate, mike]),
<a name="1021"/> 1021:     lists:foreach(fun({_User, UserSpec}) -&gt;
<a name="1022"/> 1022:                 {Username, Domain, _Pass} = get_user_data(UserSpec, Config),
<a name="1023"/> 1023:                 escalus_ejabberd:rpc(ejabberd_auth, remove_user, [Username, Domain])
<a name="1024"/> 1024:         end, Users).
<a name="1025"/> 1025: 
<a name="1026"/> 1026: <i>%%-----------------------------------------------------------------</i>
<a name="1027"/> 1027: <i>%% Predicates</i>
<a name="1028"/> 1028: <i>%%-----------------------------------------------------------------</i>
<a name="1029"/> 1029: 
<a name="match_user_status-2"/><a name="1030"/> 1030: <b>match_user_status</b>(Users, StatusTxt) -&gt;
<a name="1031"/> 1031:     Statuses = string:tokens(StatusTxt, &quot;\n&quot;),
<a name="1032"/> 1032: 
<a name="1033"/> 1033:     true = (length(Users) == length(Statuses)),
<a name="1034"/> 1034:     match_user_status2(Users, Statuses).
<a name="1035"/> 1035: 
<a name="match_user_status2-2"/><a name="1036"/> 1036: <b>match_user_status2</b>([], _) -&gt;
<a name="1037"/> 1037:     true;
<a name="1038"/> 1038: <b>match_user_status2</b>([User | UserR], Statuses) -&gt;
<a name="1039"/> 1039:     Username = binary_to_list(escalus_client:username(User)),
<a name="1040"/> 1040:     Domain = binary_to_list(escalus_client:server(User)),
<a name="1041"/> 1041:     Resource = binary_to_list(escalus_client:resource(User)),
<a name="1042"/> 1042: 
<a name="1043"/> 1043:     true = lists:any(fun(Status) -&gt;
<a name="1044"/> 1044:                 [Username, Domain, Resource]
<a name="1045"/> 1045:                 =:=
<a name="1046"/> 1046:                 lists:sublist(string:tokens(Status, &quot;\t&quot;), 1, 3)
<a name="1047"/> 1047:         end, Statuses),
<a name="1048"/> 1048:     match_user_status2(UserR, Statuses).
<a name="1049"/> 1049: 
<a name="match_user_info-2"/><a name="1050"/> 1050: <b>match_user_info</b>(Users, UsersTxt) -&gt;
<a name="1051"/> 1051:     UsersInfo = string:tokens(UsersTxt, &quot;\n&quot;),
<a name="1052"/> 1052: 
<a name="1053"/> 1053:     true = (length(Users) == length(UsersInfo)),
<a name="1054"/> 1054:     match_user_info2(Users, UsersInfo).
<a name="1055"/> 1055: 
<a name="match_user_info2-2"/><a name="1056"/> 1056: <b>match_user_info2</b>([], _) -&gt;
<a name="1057"/> 1057:     true;
<a name="1058"/> 1058: <b>match_user_info2</b>([User | UserR], UsersInfo) -&gt;
<a name="1059"/> 1059:     Username = binary_to_list(escalus_client:username(User)),
<a name="1060"/> 1060:     Domain = binary_to_list(escalus_client:server(User)),
<a name="1061"/> 1061:     Resource = binary_to_list(escalus_client:resource(User)),
<a name="1062"/> 1062:     FullJID = Username ++ &quot;@&quot; ++ Domain ++ &quot;/&quot; ++ Resource,
<a name="1063"/> 1063: 
<a name="1064"/> 1064:     true = lists:any(fun(UserInfo) -&gt;
<a name="1065"/> 1065:                 string:str(UserInfo, string:to_lower(FullJID)) =:= 1
<a name="1066"/> 1066:         end, UsersInfo),
<a name="1067"/> 1067:     match_user_info2(UserR, UsersInfo).
<a name="1068"/> 1068: 
<a name="match_roster-2"/><a name="1069"/> 1069: <b>match_roster</b>(ItemsValid, Items) -&gt;
<a name="1070"/> 1070:     ItemsTokens = [ string:tokens(ItemToken, &quot;\t&quot;) || ItemToken &lt;- string:tokens(Items, &quot;\n&quot;) ],
<a name="1071"/> 1071: 
<a name="1072"/> 1072:     true = (length(ItemsValid) == length(ItemsTokens)),
<a name="1073"/> 1073:     true = lists:all(fun({Username, Domain, Nick, Group, Sub}) -&gt;
<a name="1074"/> 1074:                     JID = escalus_utils:jid_to_lower(&lt;&lt;Username/binary, &quot;@&quot;, Domain/binary &gt;&gt;),
<a name="1075"/> 1075:                     lists:any(fun
<a name="1076"/> 1076:                                 ([RosterJID, Nick, Sub, &quot;none&quot;, Group]) -&gt;
<a name="1077"/> 1077:                                     JID =:= escalus_utils:jid_to_lower(list_to_binary(RosterJID));
<a name="1078"/> 1078:                                 (_) -&gt;
<a name="1079"/> 1079:                                     false
<a name="1080"/> 1080:                               end, ItemsTokens)
<a name="1081"/> 1081:             end, ItemsValid).
<a name="1082"/> 1082: 
<a name="string_to_binary-1"/><a name="1083"/> 1083: <b>string_to_binary</b>(List) -&gt;
<a name="1084"/> 1084:     case erlang:system_info(otp_release) of
<a name="1085"/> 1085:         [$R|_] -&gt;
<a name="1086"/> 1086:             list_to_binary(List);
<a name="1087"/> 1087:         _ -&gt;
<a name="1088"/> 1088:             unicode:characters_to_binary(List)
<a name="1089"/> 1089:     end.
</pre>
</body>
</html>
